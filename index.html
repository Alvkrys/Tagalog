<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TalaLog â€” Vocabulario Tagalog</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#34d399"/>

  <style>
    :root{
      --bg:#f7faf9; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --bd:#e5e7eb;
      --brand:#34d399; --brand-2:#a78bfa; --progress-bg:#e8eef1;
      --ok:#22c55e20; --warn:#f59e0b20; --due:#ef444420;
    }
    [data-theme="dark"]{
      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --bd:#1f2a44; --progress-bg:#1b273d;
    }
    *{box-sizing:border-box}
    body{font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:24px;max-width:1020px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    input,button,textarea,select{padding:10px;border:1px solid var(--bd);border-radius:10px;margin:4px 0;background:#fff;color:#0f172a}
    [data-theme="dark"] input,[data-theme="dark"] textarea,[data-theme="dark"] select,[data-theme="dark"] button{background:#0f172a;color:#e5e7eb;border-color:#1f2a44}
    .btn{border:1px solid var(--bd);border-radius:10px;cursor:pointer;background:#fff}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent;color:var(--muted)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    .hidden{display:none}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-right:6px}
    [data-theme="dark"] .chip{background:#1b273d;color:#c7d2fe}
    .pill{background:#fff;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);cursor:pointer}
    [data-theme="dark"] .pill{background:#0f172a;color:#94a3b8;border-color:#1f2a44}
    .flag{ font-size:28px; margin-right:8px; vertical-align:-2px }
    .rightbox{display:flex;align-items:center;gap:12px}
    .hud{display:flex;align-items:center;gap:8px}

    /* Cards + micro-animaciones */
    .card{
      background: radial-gradient(120% 120% at 100% 0%, rgba(167,139,250,.10), rgba(255,255,255,.90) 60%), var(--panel);
      border:1px solid var(--bd); border-radius:12px; padding:12px; margin:8px 0;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease, opacity .18s ease;
      will-change: transform;
    }
    .card:hover{ transform: translateY(-2px); border-color: color-mix(in oklab, var(--brand) 40%, var(--bd)); box-shadow: 0 10px 24px rgba(16,24,40,.08); }
    [data-theme="dark"] .card{ background: radial-gradient(120% 120% at 100% 0%, rgba(167,139,250,.10), rgba(15,23,42,.92) 60%), var(--panel); box-shadow:none; }
    .fade-in{ animation: fadein .25s ease-out both; } @keyframes fadein{ from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
    .slide-up{ animation: slideup .25s ease-out both; } @keyframes slideup{ from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:none} }

    .list-item{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}
    [data-theme="dark"] .list-item{border-bottom-color:#1f2a44}

    .progress{height:6px;background:var(--progress-bg);border-radius:999px;overflow:hidden;margin-top:6px}
    .progress > i{display:block;height:100%;width:var(--pct,0%);background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s ease;border-radius:inherit}

    .card.is-ok{box-shadow:0 0 0 6px var(--ok) inset}
    .card.is-warn{box-shadow:0 0 0 6px var(--warn) inset}
    .card.is-due{box-shadow:0 0 0 6px var(--due) inset}

    .list-item:hover strong{
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      -webkit-background-clip:text;background-clip:text;color:transparent
    }

    /* Toasts */
    #toast{ position:fixed; right:20px; bottom:20px; display:flex; flex-direction:column; gap:8px; z-index:9999;}
    .toast{ background:#fff; border:1px solid var(--bd); border-left:4px solid var(--brand); padding:10px 12px; border-radius:10px;
            box-shadow:0 10px 24px rgba(16,24,40,.08); color:#0f172a; min-width:220px; transition:.3s ease; }
    .toast.error{ border-left-color:#ef4444;}

    /* Review sticky + anim */
    #reviewCard{ position:sticky; bottom:12px; z-index:5 }

    /* Modal ediciÃ³n */
    #editModal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:10000}
    #editModal .box{ width:min(720px,96vw); }

    .credits{ text-align:center; color:#d4af37; font-size:12px; margin:28px 0 8px; opacity:.9; }
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toast" aria-live="polite"></div>

  <header>
    <h1><span class="flag" aria-label="Bandera de Filipinas">ðŸ‡µðŸ‡­</span> TalaLog</h1>
    <div class="rightbox">
      <div class="hud">
        <span id="todayGoal" class="pill" title="Click para cambiar meta diaria">Hoy 0/20</span>
        <span id="duePill" class="pill">Pendientes 0</span>
        <span id="streakPill" class="pill">ðŸ”¥ 0</span>
        <span id="sessionPill" class="pill" title="TamaÃ±o de sesiÃ³n">SesiÃ³n 0/12</span>
        <button id="themeBtn" class="btn ghost" title="Cambiar tema">Tema</button>
      </div>
      <div id="userBox" class="hidden">
        <span id="userEmail" class="muted"></span>
        <button id="signOutBtn" class="btn">Salir</button>
      </div>
    </div>
  </header>

  <!-- Auth -->
  <section id="authSection" class="card fade-in">
    <h3>EntrÃ¡ con tu correo (OTP)</h3>
    <div class="row">
      <input id="email" placeholder="tu@correo.com" style="min-width:260px">
      <button id="sendOtpBtn" class="btn">Enviar cÃ³digo</button>
    </div>
    <div class="row">
      <input id="otp" placeholder="CÃ³digo de 6 dÃ­gitos" style="min-width:260px">
      <button id="verifyBtn" class="btn">Verificar</button>
    </div>
    <p class="muted">RevisÃ¡ tu inbox/spam. El cÃ³digo caduca pronto.</p>
  </section>

  <!-- App -->
  <section id="appSection" class="hidden">
    <div class="card fade-in">
      <h3>Agregar palabra</h3>
      <div class="grid">
        <input id="term"    placeholder="Palabra en Tagalog *">
        <input id="meaning" placeholder="Significado (ES/EN)">
        <input id="example" placeholder="Ejemplo de uso">
        <input id="tags"    placeholder="Etiquetas: saludo,verbo (coma separadas)">
      </div>
      <div class="grid">
        <input id="notes" placeholder="Notas">
        <div class="row">
          <select id="fromLang"><option>Tagalog</option><option>English</option><option>Spanish</option></select>
          <select id="toLang"><option>Spanish</option><option>English</option></select>
          <button class="btn primary" id="addBtn">Agregar</button>
          <button id="exportBtn" class="btn">Exportar CSV</button>
          <button id="quickBtn" class="btn ghost" title="Entrada rÃ¡pida">Entrada rÃ¡pida</button>
        </div>
      </div>
      <!-- Entrada rÃ¡pida -->
      <div id="bulkBox" class="hidden">
        <textarea id="bulkTxt" rows="4" style="width:100%" placeholder="Una por lÃ­nea: palabra | significado | etiquetas | ej:â€¦"></textarea>
        <div class="row"><button id="bulkAdd" class="btn primary">Cargar</button><span class="muted">Ej: salamat | gracias | saludo | ej: Maraming salamat</span></div>
      </div>

      <div class="row">
        <input id="search" placeholder="Buscar..." style="flex:1">
        <select id="sort">
          <option value="created_at.desc">Recientes primero</option>
          <option value="term.asc">Aâ€“Z</option>
          <option value="term.desc">Zâ€“A</option>
          <option value="updated_at.desc">Editadas reciente</option>
        </select>
        <span class="muted" id="countLabel"></span>
      </div>
    </div>

    <!-- Paquetes -->
    <div class="card fade-in">
      <h3>Paquetes temÃ¡ticos</h3>
      <div class="row">
        <select id="packSelect" style="min-width:260px"></select>
        <button id="loadPackBtn" class="btn primary">Cargar paquete</button>
        <span class="muted">Agrega frases y oraciones listas para practicar.</span>
      </div>
    </div>

    <!-- VacÃ­o inteligente -->
    <div id="emptyHero" class="card hidden fade-in" style="margin-top:12px;">
      <h3>Â¿Primera vez aquÃ­?</h3>
      <p class="muted">AÃ±adÃ­ tus primeras palabras o cargÃ¡ 5 de ejemplo.</p>
      <button class="btn primary" id="addExamplesBtn">AÃ±adir ejemplos</button>
    </div>

    <div id="list" class="card fade-in"></div>

    <div class="row">
      <button class="btn primary" id="reviewBtn">Repasar hoy</button>
      <button class="btn" id="setSessionBtn" title="Cambiar tamaÃ±o de sesiÃ³n">TamaÃ±o sesiÃ³n</button>
      <span id="dueInfo" class="muted"></span>
    </div>

    <div id="reviewCard" class="card hidden slide-up">
      <div class="muted">Tarjeta <span id="revPos">0</span></div>
      <h2 id="revTerm" style="margin:8px 0 4px 0"></h2>
      <div id="revHint" class="muted"></div>
      <button id="showAnsBtn" class="btn">Mostrar significado</button>
      <div id="revAnswer" class="hidden" style="margin-top:8px">
        <strong id="revMeaning"></strong>
        <div id="revExample" class="muted" style="margin-top:4px"></div>
      </div>
      <div class="row">
        <button class="btn" data-q="0" title="J / 1">Again</button>
        <button class="btn" data-q="3" title="K / 2">Good</button>
        <button class="btn" data-q="5" title="L / 3">Easy</button>
      </div>
    </div>
  </section>

  <!-- Modal ediciÃ³n -->
  <div id="editModal">
    <div class="box card">
      <h3>Editar palabra</h3>
      <input id="e_term" placeholder="Palabra">
      <input id="e_meaning" placeholder="Significado">
      <input id="e_example" placeholder="Ejemplo">
      <input id="e_notes" placeholder="Notas">
      <input id="e_tags" placeholder="Etiquetas coma separadas">
      <div class="row">
        <button id="e_save" class="btn primary">Guardar</button>
        <button id="e_cancel" class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  /* ===== Supabase ===== */
  const SUPABASE_URL = "https://wszrttutzsmzayzpbnjq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzenJ0dHV0enNtemF5enBibmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODI4MzAsImV4cCI6MjA3MTE1ODgzMH0.2Xkc4vCPbJ1W9Sbp78Ae_qvKZHC_GP8Dtq4Ub6ZZW1M";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== Utils ===== */
  const qs = s => document.querySelector(s);
  const isOnline = () => navigator.onLine;
  function showToast(msg,type='ok'){
    const wrap = qs('#toast'); if(!wrap) return alert(msg);
    const el = document.createElement('div'); el.className='toast '+(type==='error'?'error':'ok'); el.textContent=msg;
    wrap.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; el.addEventListener('transitionend',()=>el.remove(),{once:true}); },2000);
  }
  const _alert = window.alert.bind(window); window.alert=(m)=>showToast(m,'ok');
  function debounce(fn,ms){let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);};}
  function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js',{scope:'./'}).catch(()=>{}); }

  const authSection = qs('#authSection'); const appSection=qs('#appSection');
  const userBox=qs('#userBox'); const userEmailEl=qs('#userEmail'); const listEl=qs('#list'); const countEl=qs('#countLabel');

  /* ===== Tema ===== */
  const themeBtn = qs('#themeBtn'); function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('talalog.theme', t); }
  setTheme(localStorage.getItem('talalog.theme')||'light'); themeBtn.onclick=()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

  /* ===== Metas, racha y sesiÃ³n ===== */
  let GOAL = +(localStorage.getItem('talalog.goal')||20);
  let SESSION_SIZE = +(localStorage.getItem('talalog.session')||12);
  let sessionCount = 0; const goalPill=qs('#todayGoal'); const sessionPill=qs('#sessionPill');
  goalPill.onclick=()=>{ const g=+prompt('Meta diaria (nÃºmero):',GOAL)||GOAL; GOAL=g; localStorage.setItem('talalog.goal',g); updateTodayPill(); };
  qs('#setSessionBtn').onclick=()=>{ const s=+prompt('TamaÃ±o de sesiÃ³n (8â€“20):',SESSION_SIZE)||SESSION_SIZE; SESSION_SIZE=Math.min(20,Math.max(8,s)); localStorage.setItem('talalog.session',SESSION_SIZE); updateSessionPill(); };

  const todayKey = ()=> new Date().toISOString().slice(0,10);
  function getTodayObj(){ const k='talalog.today.'+todayKey(); return { key:k, count:+(localStorage.getItem(k)||0) }; }
  function updateTodayPill(v){ const c = v!=null? v : getTodayObj().count; qs('#todayGoal').textContent = `Hoy ${c}/${GOAL}`; }
  function incToday(n=1){ const t=getTodayObj(); const v=t.count+n; localStorage.setItem(t.key, v); updateTodayPill(v); localStorage.setItem('talalog.lastActive', todayKey()); maybeDailyConfetti(); }
  function bumpStreakIfNeeded(){
    const today = todayKey(); const last = localStorage.getItem('talalog.lastActive'); let s=+(localStorage.getItem('talalog.streak')||0);
    if(last!==today){ const y = new Date(); y.setDate(y.getDate()-1); s = (last === y.toISOString().slice(0,10)) ? s+1 : 1; localStorage.setItem('talalog.streak', s); localStorage.setItem('talalog.lastActive', today); }
    qs('#streakPill').textContent = `ðŸ”¥ ${s}`;
  }
  function updateSessionPill(){ sessionPill.textContent=`SesiÃ³n ${sessionCount}/${SESSION_SIZE}`; }
  async function updateDuePill(){
    if(!isOnline()){ const rows=loadCache(); const now=new Date().toISOString(); const c=rows.filter(r=>(r.next_review_at||'')<=now).length; qs('#duePill').textContent=`Pendientes ${c}`; qs('#dueInfo').textContent=`${c} para repasar`; return; }
    const { data:{session} }=await client.auth.getSession(); if(!session) return;
    const now=new Date().toISOString();
    const { count } = await client.from('words').select('id',{count:'exact',head:true}).eq('user_id',session.user.id).lte('next_review_at',now);
    qs('#duePill').textContent=`Pendientes ${count||0}`; qs('#dueInfo').textContent=`${count||0} para repasar`;
  }
  async function updateCounters(){ updateTodayPill(); updateSessionPill(); bumpStreakIfNeeded(); await updateDuePill(); }

  /* ===== Confetti minimal ===== */
  function confetti(){
    const c = document.createElement('div'); c.style.position='fixed'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex=9998; document.body.appendChild(c);
    for(let i=0;i<80;i++){ const p=document.createElement('i'); const s=6+Math.random()*6; p.style.position='absolute'; p.style.left=(Math.random()*100)+'%'; p.style.top='-10px'; p.style.width=s+'px'; p.style.height=s+'px';
      p.style.background=`hsl(${Math.random()*360},90%,60%)`; p.style.opacity=.9; p.style.borderRadius='2px';
      p.style.transform=`rotate(${Math.random()*360}deg)`; p.style.transition='transform 1.2s linear, top 1.2s linear, opacity 1.2s ease-out';
      c.appendChild(p); setTimeout(()=>{ p.style.top='110%'; p.style.transform=`translateY(0) rotate(${360+Math.random()*360}deg)`; p.style.opacity='0'; },10);
    } setTimeout(()=>c.remove(),1400);
  }
  function maybeDailyConfetti(){
    const k='talalog.confetti.'+todayKey();
    if(localStorage.getItem(k)) return;
    const t=getTodayObj(); if(t.count>=GOAL){ confetti(); localStorage.setItem(k,'1'); }
  }

  /* ===== CachÃ© simple (para offline UI) ===== */
  const CACHE_KEY='talalog.cache';
  function saveCache(rows){ localStorage.setItem(CACHE_KEY, JSON.stringify(rows)); }
  function loadCache(){ try { return JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); } catch(e){ return []; } }

  /* ===== OTP ===== */
  qs('#sendOtpBtn').onclick = async () => {
    const email = qs('#email').value.trim(); if (!email) return showToast('PonÃ© tu correo','error');
    const { error } = await client.auth.signInWithOtp({ email }); if (error) return showToast(error.message,'error');
    showToast('CÃ³digo enviado. RevisÃ¡ tu email.');
  };
  qs('#verifyBtn').onclick = async () => {
    const email = qs('#email').value.trim(); const token = qs('#otp').value.trim();
    if (!email || !token) return showToast('Correo y cÃ³digo','error');
    const { error } = await client.auth.verifyOtp({ email, token, type: 'email' });
    if (error) return showToast(error.message,'error');
    await onAuthed();
  };
  qs('#signOutBtn').onclick = async () => { await client.auth.signOut(); location.reload(); };

  async function onAuthed() {
    const { data: { user } } = await client.auth.getUser();
    userEmailEl.textContent = user?.email || '';
    authSection.classList.add('hidden');
    userBox.classList.remove('hidden');
    appSection.classList.remove('hidden');
    await loadWords();
    await updateCounters();
    weeklyBackup(); // intenta backup al entrar
  }

  /* ===== Agregar palabra ===== */
  qs('#addBtn').onclick = addWord;
  async function addWord() {
    const term=qs('#term').value.trim(), meaning=qs('#meaning').value.trim(), example=qs('#example').value.trim(), notes=qs('#notes').value.trim();
    const tagsRaw=qs('#tags').value.trim(); const tags=tagsRaw?tagsRaw.split(',').map(s=>s.trim()).filter(Boolean):null;
    if (!term || !meaning) return showToast('Palabra y significado son obligatorios','error');

    const { data:{session} }=await client.auth.getSession(); if(!session) return showToast('IniciÃ¡ sesiÃ³n','error');

    // FSRS init: dificultad ~ 5 (medio), estabilidad inicial 1 dÃ­a
    const row = {
      user_id: session.user.id, term, meaning,
      example: example||null, notes: notes||null, tags,
      from_lang: qs('#fromLang').value, to_lang: qs('#toLang').value,
      // mapeo: ease= dificultad FSRS (1â€“10), interval_days = estabilidad (float en dÃ­as)
      ease: 5.0, repetitions: 0, interval_days: 1,
      last_review_at: null, next_review_at: new Date().toISOString()
    };

    const { error } = await client.from('words').insert(row).select().single();
    if (error) { console.error(error); return showToast('No se pudo guardar: '+error.message,'error'); }

    ['#term','#meaning','#example','#notes','#tags'].forEach(id => qs(id).value = '');
    showToast('Palabra agregada'); await loadWords(); await updateCounters();
  }

  /* ===== Entrada rÃ¡pida ===== */
  qs('#quickBtn').onclick = ()=> qs('#bulkBox').classList.toggle('hidden');
  qs('#bulkAdd').onclick = async ()=>{
    const { data:{session} } = await client.auth.getSession(); if(!session) return showToast('IniciÃ¡ sesiÃ³n','error');
    const lines = qs('#bulkTxt').value.split('\n').map(s=>s.trim()).filter(Boolean); if(!lines.length) return;
    const now = new Date().toISOString();
    const rows = lines.map(L=>{
      const [t,m,tags,ex] = L.split('|').map(x=>x?.trim()||'');
      return {user_id:session.user.id, term:t, meaning:m, example:ex||null, notes:null, tags:tags?tags.split(',').map(s=>s.trim()):['bulk'],
              from_lang:'Tagalog', to_lang:'Spanish', ease:5.0, repetitions:0, interval_days:1, next_review_at:now};
    }).filter(r=>r.term && r.meaning);
    const { error } = await client.from('words').insert(rows);
    if(error) return showToast(error.message,'error');
    qs('#bulkTxt').value=''; showToast(`Agregadas ${rows.length}`); await loadWords(); await updateCounters();
  };

  /* ===== Paquetes ===== */
  const PACKS = {
    "Entrevista de trabajo (bÃ¡sico)": [
      ["Anong pangalan mo?","Â¿CÃ³mo te llamas?","interview",""],
      ["Ano ang karanasan mo?","Â¿CuÃ¡l es tu experiencia?","interview",""],
      ["Magkano ang inaasahang sahod mo?","Â¿CuÃ¡l es tu salario esperado?","interview",""],
      ["Bakit gusto mo ang trabahong ito?","Â¿Por quÃ© quieres este trabajo?","interview",""],
      ["Anong mga lakas mo?","Â¿CuÃ¡les son tus fortalezas?","interview",""]
    ],
    "Conociendo a desconocidos": [
      ["Kamusta?","Â¿CÃ³mo estÃ¡s?","social",""],
      ["Tagasaan ka?","Â¿De dÃ³nde eres?","social",""],
      ["Anong ginagawa mo dito?","Â¿QuÃ© haces por aquÃ­?","social",""],
      ["Ilang taon ka na?","Â¿CuÃ¡ntos aÃ±os tienes?","social",""],
      ["Saan ka nakatira?","Â¿DÃ³nde vives?","social",""]
    ],
    "Restaurante": [
      ["Puwede bang menu?","Â¿Me puede dar el menÃº?","food",""],
      ["Magkano ito?","Â¿CuÃ¡nto cuesta esto?","food",""],
      ["Isang tubig, pakiusap.","Un agua, por favor.","food",""],
      ["Masarap ba ito?","Â¿EstÃ¡ rico esto?","food",""],
      ["Pwede bang take-out?","Â¿Puedo llevar para llevar?","food",""]
    ],
    "Inmobiliario / Apartamentos": [
      ["Magkano ang renta bawat buwan?","Â¿CuÃ¡nto es la renta mensual?","real-estate",""],
      ["Kasama ba ang kuryente at tubig?","Â¿Incluye electricidad y agua?","real-estate",""],
      ["Pet-friendly ba?","Â¿Aceptan mascotas?","real-estate",""],
      ["May parking ba?","Â¿Hay parqueo?","real-estate",""],
      ["Kailan puwede lumipat?","Â¿CuÃ¡ndo puedo mudarme?","real-estate",""]
    ]
  };
  const packSelect = qs('#packSelect');
  Object.keys(PACKS).forEach(k=>{ const o=document.createElement('option'); o.textContent=k; o.value=k; packSelect.appendChild(o); });
  qs('#loadPackBtn').onclick=async()=>{
    const key=packSelect.value; if(!key) return;
    const items=PACKS[key]; const { data:{session} }=await client.auth.getSession(); if(!session) return showToast('IniciÃ¡ sesiÃ³n','error');
    const now=new Date().toISOString();
    const rows = items.map(([t,m,tag,ex])=>({user_id:session.user.id, term:t, meaning:m, example:ex||null, notes:null, tags:[tag],
      from_lang:'Tagalog', to_lang:'Spanish', ease:5.0, repetitions:0, interval_days:1, next_review_at:now}));
    const { error } = await client.from('words').insert(rows);
    if(error) return showToast(error.message,'error');
    showToast(`Cargado paquete: ${key}`); await loadWords(); await updateCounters();
  };

  /* ===== BÃºsqueda / ordenar ===== */
  qs('#search').oninput = debounce(()=>loadWords(), 250);
  qs('#sort').onchange  = () => loadWords();

  async function loadWords() {
    const { data:{session} } = await client.auth.getSession(); if(!session) return;
    const q = qs('#search').value.trim(); const [col, dir] = (qs('#sort').value || 'created_at.desc').split('.');
    let query = client.from('words').select('*').eq('user_id', session.user.id).order(col, { ascending: dir !== 'desc' }).limit(1000);
    if (q) query = query.or(`term.ilike.%${q}%,meaning.ilike.%${q}%`);
    const { data, error } = await query; if (error) { console.error(error); showToast(error.message,'error'); return; }
    saveCache(data||[]); renderList(data||[]); toggleEmptyHero(!(data&&data.length));
  }
  function toggleEmptyHero(show){ qs('#emptyHero')?.classList[show?'remove':'add']('hidden'); }

  /* ===== Frescura ===== */
  function freshnessPct(row){
    if(!row.last_review_at) return 0; // nunca practicado
    const last = new Date(row.last_review_at); const now = new Date();
    const daysSince = (now - last) / 86400000;
    const stability = Math.max(1, +row.interval_days || 1); // usamos interval_days como estabilidad FSRS
    const left = Math.max(0, 1 - (daysSince / stability));
    return Math.round(left * 100);
  }

  /* ===== Render lista + editar/eliminar ===== */
  function renderList(rows) {
    countEl.textContent = `${rows.length} palabra(s)`;
    listEl.innerHTML = '';
    if (!rows.length) { listEl.innerHTML = '<div class="muted">No hay resultados. AgregÃ¡ tu primera palabra ðŸ«°</div>'; return; }
    rows.forEach(r => {
      const pct = freshnessPct(r);
      const stateClass = pct > 60 ? 'is-ok' : pct > 25 ? 'is-warn' : 'is-due';
      const div = document.createElement('div');
      div.className = `list-item card ${stateClass}`;
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(r.term)}</strong>
          <div class="muted">${escapeHtml(r.example||'')}</div>
          <div class="progress"><i style="--pct:${pct}%"></i></div>
        </div>
        <div>
          ${escapeHtml(r.meaning||'')}
          <div>${(r.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
        </div>
        <div class="right">
          <button class="btn" onclick="openEdit('${r.id}')">Editar</button>
          <button class="btn" onclick="delWord('${r.id}')">Eliminar</button>
        </div>`;
      listEl.appendChild(div);
    });
  }
  window.delWord = async (id) => {
    const { error } = await client.from('words').delete().eq('id', id);
    if (error) { console.error(error); return showToast(error.message,'error'); }
    showToast('Eliminado'); await loadWords(); await updateCounters();
  };
  // Editar
  let editRow=null;
  window.openEdit = async (id)=>{
    const { data, error } = await client.from('words').select('*').eq('id', id).single();
    if(error) return showToast(error.message,'error');
    editRow = data; qs('#e_term').value=data.term||''; qs('#e_meaning').value=data.meaning||''; qs('#e_example').value=data.example||''; qs('#e_notes').value=data.notes||''; qs('#e_tags').value=(data.tags||[]).join(', ');
    qs('#editModal').style.display='flex';
  };
  qs('#e_cancel').onclick = ()=>{ qs('#editModal').style.display='none'; editRow=null; };
  qs('#e_save').onclick = async ()=>{
    if(!editRow) return;
    const updates = { term:qs('#e_term').value.trim(), meaning:qs('#e_meaning').value.trim(), example:qs('#e_example').value.trim()||null, notes:qs('#e_notes').value.trim()||null, tags:(qs('#e_tags').value.split(',').map(s=>s.trim()).filter(Boolean)||null) };
    const { error } = await client.from('words').update(updates).eq('id', editRow.id);
    if(error) return showToast(error.message,'error');
    qs('#editModal').style.display='none'; editRow=null; showToast('Actualizado'); await loadWords();
  };

  /* ===== Export CSV ===== */
  qs('#exportBtn').onclick = async () => {
    const { data } = await client.from('words').select('*'); const rows=data||[];
    if (!rows.length){ showToast('Nada para exportar','error'); return; }
    const csv = ['term,meaning,example,notes,tags,from_lang,to_lang,created_at']
      .concat(rows.map(r => [r.term,r.meaning,r.example||'',r.notes||'',(r.tags||[]).join('|'),r.from_lang||'',r.to_lang||'',r.created_at].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='talalog.csv'; a.click(); URL.revokeObjectURL(url);
  };

  /* ===== FSRS (simplificado y estable) =====
     - Usamos columnas existentes:
       ease -> dificultad (D) en [1..10], intervalo -> estabilidad (S) en dÃ­as (float).
     - Ratings: Again(0), Good(3), Easy(5)
  */
  function fsrsUpdate(D=5, S=1, rating=3){
    // parÃ¡metros suaves (inspirados en FSRS): mÃ¡s fÃ¡cil â†’ crece mÃ¡s S, baja ligeramente D
    D = Math.min(10, Math.max(1, +D||5));
    S = Math.max(0.5, +S||1);

    if (rating<=0){ // Again
      D = Math.min(10, D + 1.0);
      S = Math.max(0.5, S * 0.5);
      const interval = 1; // 1 dÃ­a
      return { D, S, interval };
    }

    if (rating>=5){ // Easy
      D = Math.max(1, D - 0.5);
      const growth = 1.30 + 0.05*(10-D);      // recompensa mayor si D bajo (mÃ¡s fÃ¡cil)
      S = Math.max(1, S * growth);
      const interval = Math.round(S);
      return { D, S, interval };
    }

    // Good
    // crecimiento moderado, depende de la dificultad
    const growth = 1.15 + 0.04*(10-D);
    S = Math.max(1, S * growth);
    // pequeÃ±a tendencia a bajar dificultad si repetÃ­s aciertos
    D = Math.max(1, D - 0.2);
    const interval = Math.round(S);
    return { D, S, interval };
  }

  /* ===== Repaso (con sesiones) ===== */
  let reviewQueue=[], current=null, reviewed=0;
  const reviewBtn = qs('#reviewBtn');
  qs('#showAnsBtn').onclick = () => qs('#revAnswer').classList.toggle('hidden');
  document.querySelectorAll('#reviewCard [data-q]').forEach(b=>b.onclick=()=>gradeCard(+b.dataset.q));
  reviewBtn.onclick = startReview;

  async function startReview() {
    const { data:{session} } = await client.auth.getSession(); if (!session) return;
    reviewBtn.disabled = true; const old = reviewBtn.textContent; reviewBtn.textContent='Cargandoâ€¦';

    const nowIso = new Date().toISOString();
    let { data, error } = await client.from('words')
      .select('*').eq('user_id', session.user.id)
      .lte('next_review_at', nowIso)
      .order('next_review_at', { ascending:true });

    if (error){ showToast(error.message,'error'); reviewBtn.disabled=false; reviewBtn.textContent=old; return; }

    let pool = data || [];
    if (!pool.length){
      // Refuerzo: toma las 20 de frescura mÃ¡s baja
      const all = (await client.from('words').select('*').eq('user_id', session.user.id).limit(1000)).data||[];
      pool = all.sort((a,b)=>freshnessPct(a)-freshnessPct(b)).slice(0,20);
      if(!pool.length){ showToast('Nada para hoy. Â¡AgregÃ¡ o practicÃ¡ maÃ±ana!'); reviewBtn.disabled=false; reviewBtn.textContent=old; return; }
      showToast('Modo refuerzo (sin vencidas).');
    }

    sessionCount = 0; updateSessionPill();
    reviewQueue = pool.slice(0, SESSION_SIZE); // SesiÃ³n corta
    reviewed = 0; qs('#dueInfo').textContent = `${reviewQueue.length} en esta sesiÃ³n`;
    nextCard();

    reviewBtn.disabled=false; reviewBtn.textContent=old;
  }

  function nextCard() {
    current = reviewQueue.shift();
    if (!current) {
      qs('#reviewCard').classList.add('hidden');
      qs('#dueInfo').textContent = `SesiÃ³n completa`;
      showToast('Â¡Repaso listo!'); confetti();
      updateCounters(); return;
    }
    reviewed++; sessionCount++; updateSessionPill();
    qs('#revPos').textContent = `${reviewed}`;
    qs('#revTerm').textContent = current.term;
    qs('#revHint').textContent = (current.from_lang||'Tagalog')+' â†’ '+(current.to_lang||'Spanish');
    qs('#revMeaning').textContent = current.meaning||'';
    qs('#revExample').textContent = current.example||'';
    qs('#revAnswer').classList.add('hidden');
    const card = qs('#reviewCard'); card.classList.remove('hidden'); card.classList.remove('slide-up'); void card.offsetWidth; card.classList.add('slide-up');
  }

  async function gradeCard(quality) {
    if (!current) return;
    // Mapear a FSRS
    const D = +current.ease || 5; const S = +current.interval_days || 1;
    const { D:nd, S:ns, interval } = fsrsUpdate(D, S, quality);
    const next = new Date(); next.setDate(next.getDate() + Math.max(1, interval||1));
    const nowIso = new Date().toISOString();

    const updates = {
      ease: nd, interval_days: ns, repetitions: (current.repetitions||0) + (quality>=3?1:0),
      last_review_at: nowIso, next_review_at: next.toISOString()
    };

    const { error } = await client.from('words').update(updates).eq('id', current.id);
    if (error) { console.error(error); return showToast('No pude actualizar: '+error.message,'error'); }

    if (quality >= 3) incToday(1);
    await loadWords(); nextCard();
  }

  // Atajos de teclado
  document.addEventListener('keydown',(e)=>{
    const card = qs('#reviewCard'); const k=e.key.toLowerCase();
    if(card && !card.classList.contains('hidden')){
      if(e.code==='Space'){ e.preventDefault(); qs('#revAnswer').classList.toggle('hidden'); return; }
      if(k==='1'||k==='j'){ gradeCard(0); return; }
      if(k==='2'||k==='k'){ gradeCard(3); return; }
      if(k==='3'||k==='l'){ gradeCard(5); return; }
      if(e.key==='Escape'){ card.classList.add('hidden'); return; }
    }
    if(k==='enter' && document.activeElement.closest('#appSection')){ e.preventDefault(); addWord(); }
    if((e.ctrlKey||e.metaKey) && k==='k'){ e.preventDefault(); qs('#search').focus(); }
  });

  /* ===== Backup semanal automÃ¡tico =====
     Intenta crear snapshot en tabla 'backups' con columnas:
       user_id uuid, created_at timestamptz default now(), payload jsonb
     Si no existe o falla RLS â†’ descarga JSON local.
  */
  async function weeklyBackup(){
    if(!isOnline()) return;
    const last = localStorage.getItem('talalog.lastBackup'); const now = Date.now();
    if(last && (now - +last) < 7*24*60*60*1000) return; // menos de 7 dÃ­as
    const { data:{session} } = await client.auth.getSession(); if(!session) return;
    const { data, error } = await client.from('words').select('*').eq('user_id', session.user.id).limit(5000);
    if(error){ console.error(error); return; }
    try{
      const ins = await client.from('backups').insert({ user_id: session.user.id, payload: data||[] });
      if(ins.error) throw ins.error;
      showToast('Backup semanal guardado en Supabase âœ“');
      localStorage.setItem('talalog.lastBackup', String(now));
    }catch(e){
      // Fallback: descarga local
      const blob=new Blob([JSON.stringify(data||[],null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`talalog-backup-${todayKey()}.json`; a.click(); URL.revokeObjectURL(a.href);
      showToast('No pude escribir en Supabase. Te bajÃ© un backup local.', 'error');
      localStorage.setItem('talalog.lastBackup', String(now));
    }
  }

  /* ===== Init ===== */
  client.auth.getSession().then(({data:{session}})=>{ if (session) onAuthed(); });
  window.addEventListener('online', ()=>{ showToast('Conectado'); updateDuePill(); weeklyBackup(); });
  window.addEventListener('offline', ()=> showToast('Sin conexiÃ³n Â· modo cachÃ©') );

  </script>
  <footer class="credits">Gawa ni Harry</footer>
</body>
</html>
