<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TalaLog — Vocabulario Tagalog</title>
  <style>
    /* ===== Paleta clara y tranquila (menta + lavanda) ===== */
    :root{
      --bg:#f7faf9;        /* fondo muy claro */
      --panel:#ffffff;     /* tarjetas y paneles */
      --ink:#0f172a;       /* texto principal */
      --muted:#64748b;     /* texto secundario */
      --bd:#e5e7eb;        /* bordes sutiles */

      --brand:#34d399;     /* menta (primario) */
      --brand-2:#a78bfa;   /* lavanda (complemento) */

      --progress-bg:#e8eef1; /* fondo de barra */

      --ok:#22c55e20;      /* halos opcionales */
      --warn:#f59e0b20;
      --due:#ef444420;
    }
    /* ===== Modo oscuro ===== */
    [data-theme="dark"]{
      --bg:#0b1020;
      --panel:#0f172a;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --bd:#1f2a44;
      --progress-bg:#1b273d;
    }

    *{box-sizing:border-box}
    body{font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:24px;max-width:980px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    input,button,textarea,select{padding:10px;border:1px solid var(--bd);border-radius:10px;margin:4px 0;background:#fff;color:#0f172a}
    [data-theme="dark"] input,[data-theme="dark"] textarea,[data-theme="dark"] select,[data-theme="dark"] button{background:#0f172a;color:#e5e7eb;border-color:#1f2a44}
    .btn{border:1px solid var(--bd);border-radius:10px;cursor:pointer;background:#fff}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent;color:var(--muted)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:728px){.grid{grid-template-columns:1fr}}
    .hidden{display:none}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-right:6px}
    [data-theme="dark"] .chip{background:#1b273d;color:#c7d2fe}

    /* Tarjeta con hover suave (color complementario) */
    .card{
      background: radial-gradient(120% 120% at 100% 0%, rgba(167,139,250,.10), rgba(255,255,255,.90) 60%), var(--panel);
      border:1px solid var(--bd);
      border-radius:12px;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      padding:12px;
      margin:8px 0;
    }
    [data-theme="dark"] .card{
      background: radial-gradient(120% 120% at 100% 0%, rgba(167,139,250,.10), rgba(15,23,42,.92) 60%), var(--panel);
    }
    .card:hover{
      transform: translateY(-3px);
      border-color: color-mix(in oklab, var(--brand) 40%, var(--bd));
      box-shadow: 0 10px 24px rgba(16,24,40,.08);
      background: radial-gradient(120% 120% at 100% 0%, rgba(52,211,153,.10), rgba(255,255,255,.92) 60%), var(--panel);
    }
    [data-theme="dark"] .card:hover{
      background: radial-gradient(120% 120% at 100% 0%, rgba(52,211,153,.10), rgba(15,23,42,.92) 60%), var(--panel);
      box-shadow:none;
    }

    /* Lista */
    .list-item{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}
    [data-theme="dark"] .list-item{border-bottom-color:#1f2a44}

    /* Barra de progreso “frescura” */
    .progress{height:6px;background:var(--progress-bg);border-radius:999px;overflow:hidden;margin-top:6px}
    .progress > i{display:block;height:100%;width:var(--pct,0%);background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s ease;border-radius:inherit}

    /* Halos (opcional) según estado */
    .card.is-ok{box-shadow:0 0 0 6px var(--ok) inset}
    .card.is-warn{box-shadow:0 0 0 6px var(--warn) inset}
    .card.is-due{box-shadow:0 0 0 6px var(--due) inset}

    /* Texto hover */
    .list-item:hover strong{
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      -webkit-background-clip:text;background-clip:text;color:transparent
    }

    /* Encabezado: bandera, HUD y crédito */
    .flag{ font-size:28px; margin-right:8px; vertical-align:-2px }
    .rightbox{display:flex;align-items:center;gap:12px}
    .hud{display:flex;align-items:center;gap:8px}
    .pill{background:#fff;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);cursor:pointer}
    [data-theme="dark"] .pill{background:#0f172a;color:#94a3b8;border-color:#1f2a44}

    .credits{
      text-align:center;
      color:#d4af37;      /* dorado */
      font-size:12px;     /* pequeño */
      margin:28px 0 8px;
      opacity:.9;
    }

    /* Toasts */
    #toast{ position:fixed; right:20px; bottom:20px; display:flex; flex-direction:column; gap:8px; z-index:9999;}
    .toast{ background:#fff; border:1px solid var(--bd); border-left:4px solid var(--brand); padding:10px 12px; border-radius:10px;
            box-shadow:0 10px 24px rgba(16,24,40,.08); color:#0f172a; min-width:220px; transition:.3s ease; }
    .toast.error{ border-left-color:#ef4444;}

    /* Review sticky */
    #reviewCard{ position:sticky; bottom:12px; z-index:5 }

    /* Modal de edición */
    #editModal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:10000}
    #editModal .box{ width:min(720px,96vw); }
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toast" aria-live="polite"></div>

  <header>
    <h1><span class="flag" aria-label="Bandera de Filipinas">🇵🇭</span> TalaLog</h1>

    <div class="rightbox">
      <div class="hud">
        <span id="todayGoal" class="pill" title="Click para cambiar meta diaria">Hoy 0/20</span>
        <span id="duePill" class="pill">Pendientes 0</span>
        <span id="streakPill" class="pill">🔥 0</span>
        <button id="themeBtn" class="btn ghost" title="Cambiar tema">Tema</button>
      </div>

      <div id="userBox" class="hidden">
        <span id="userEmail" class="muted"></span>
        <button id="signOutBtn" class="btn">Salir</button>
      </div>
    </div>
  </header>

  <!-- === Auth (OTP) === -->
  <section id="authSection" class="card">
    <h3>Entrá con tu correo (OTP)</h3>
    <div class="row">
      <input id="email" placeholder="tu@correo.com" style="min-width:260px">
      <button id="sendOtpBtn" class="btn">Enviar código</button>
    </div>
    <div class="row">
      <input id="otp" placeholder="Código de 6 dígitos" style="min-width:260px">
      <button id="verifyBtn" class="btn">Verificar</button>
    </div>
    <p class="muted">Revisá tu inbox/spam. El código caduca pronto.</p>
  </section>

  <!-- === App === -->
  <section id="appSection" class="hidden">
    <div class="card">
      <h3>Agregar palabra</h3>
      <div class="grid">
        <input id="term"    placeholder="Palabra en Tagalog *">
        <input id="meaning" placeholder="Significado (ES/EN)">
        <input id="example" placeholder="Ejemplo de uso">
        <input id="tags"    placeholder="Etiquetas: saludo,verbo (coma separadas)">
      </div>
      <div class="grid">
        <input id="notes" placeholder="Notas">
        <div class="row">
          <select id="fromLang"><option>Tagalog</option><option>English</option><option>Spanish</option></select>
          <select id="toLang"><option>Spanish</option><option>English</option></select>
          <button class="btn primary" id="addBtn">Agregar</button>
          <button id="exportBtn" class="btn">Exportar CSV</button>
          <button id="quickBtn" class="btn ghost" title="Entrada rápida">Entrada rápida</button>
        </div>
      </div>

      <!-- Entrada rápida -->
      <div id="bulkBox" class="hidden">
        <textarea id="bulkTxt" rows="4" style="width:100%" placeholder="Una por línea: palabra - significado"></textarea>
        <div class="row"><button id="bulkAdd" class="btn primary">Cargar</button><span class="muted">Ej: salamat - gracias</span></div>
      </div>

      <div class="row">
        <input id="search" placeholder="Buscar..." style="flex:1">
        <select id="sort">
          <option value="created_at.desc">Recientes primero</option>
          <option value="term.asc">A–Z</option>
          <option value="term.desc">Z–A</option>
          <option value="updated_at.desc">Editadas reciente</option>
        </select>
        <span class="muted" id="countLabel"></span>
      </div>
    </div>

    <!-- Vacío inteligente -->
    <div id="emptyHero" class="card hidden" style="margin-top:12px;">
      <h3>¿Primera vez aquí?</h3>
      <p class="muted">Añadí tus primeras palabras o te cargo 5 de ejemplo.</p>
      <button class="btn primary" id="addExamplesBtn">Añadir ejemplos</button>
    </div>

    <div id="list" class="card"></div>

    <div class="row">
      <button class="btn primary" id="reviewBtn">Repasar hoy</button>
      <span id="dueInfo" class="muted"></span>
    </div>

    <div id="reviewCard" class="card hidden">
      <div class="muted">Tarjeta <span id="revPos">0</span></div>
      <h2 id="revTerm" style="margin:8px 0 4px 0"></h2>
      <div id="revHint" class="muted"></div>
      <button id="showAnsBtn" class="btn">Mostrar significado</button>
      <div id="revAnswer" class="hidden" style="margin-top:8px">
        <strong id="revMeaning"></strong>
        <div id="revExample" class="muted" style="margin-top:4px"></div>
      </div>
      <div class="row">
        <button class="btn" data-q="0" title="J">Again</button>
        <button class="btn" data-q="3" title="K">Good</button>
        <button class="btn" data-q="5" title="L">Easy</button>
      </div>
    </div>
  </section>

  <!-- Modal de edición -->
  <div id="editModal">
    <div class="box card">
      <h3>Editar palabra</h3>
      <input id="e_term" placeholder="Palabra">
      <input id="e_meaning" placeholder="Significado">
      <input id="e_example" placeholder="Ejemplo">
      <input id="e_notes" placeholder="Notas">
      <input id="e_tags" placeholder="Etiquetas coma separadas">
      <div class="row">
        <button id="e_save" class="btn primary">Guardar</button>
        <button id="e_cancel" class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  /* ===== Config Supabase ===== */
  const SUPABASE_URL = "https://wszrttutzsmzayzpbnjq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzenJ0dHV0enNtemF5enBibmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODI4MzAsImV4cCI6MjA3MTE1ODgzMH0.2Xkc4vCPbJ1W9Sbp78Ae_qvKZHC_GP8Dtq4Ub6ZZW1M";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== Helpers UI ===== */
  const qs = s => document.querySelector(s);
  function showToast(msg,type='ok'){
    const wrap = qs('#toast'); if(!wrap) return window._nativeAlert ? _nativeAlert(msg) : console.log(msg);
    const el = document.createElement('div');
    el.className = 'toast ' + (type==='error' ? 'error' : 'ok');
    el.textContent = msg;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)';
      el.addEventListener('transitionend', ()=>el.remove(), {once:true});
    }, 2000);
  }
  const _nativeAlert = window.alert.bind(window);
  window.alert = (m)=>showToast(m,'ok');
  function debounce(fn,ms){let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);};}
  function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

  const authSection = qs('#authSection');
  const appSection  = qs('#appSection');
  const userBox     = qs('#userBox');
  const userEmailEl = qs('#userEmail');
  const listEl      = qs('#list');
  const countEl     = qs('#countLabel');

  /* ===== Tema ===== */
  const themeBtn = qs('#themeBtn');
  function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('talalog.theme', t); }
  setTheme(localStorage.getItem('talalog.theme')||'light');
  themeBtn.onclick=()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

  /* ===== Metas & racha ===== */
  let GOAL = +(localStorage.getItem('talalog.goal')||20);
  const goalPill = qs('#todayGoal');
  goalPill.onclick = ()=>{ const g = +prompt('Meta diaria (número):', GOAL)||GOAL; GOAL=g; localStorage.setItem('talalog.goal',g); updateTodayPill(); };

  const todayKey = ()=> new Date().toISOString().slice(0,10);
  function getTodayObj(){ const k='talalog.today.'+todayKey(); return { key:k, count:+(localStorage.getItem(k)||0) }; }
  function updateTodayPill(v){ const c = v!=null? v : getTodayObj().count; qs('#todayGoal').textContent = `Hoy ${c}/${GOAL}`; }
  function incToday(n=1){ const t=getTodayObj(); const v=t.count+n; localStorage.setItem(t.key, v); updateTodayPill(v); }
  function bumpStreakIfNeeded(){
    const today = todayKey();
    const last  = localStorage.getItem('talalog.lastActive');
    let s = +localStorage.getItem('talalog.streak')||0;
    if(last!==today){
      const y = new Date(); y.setDate(y.getDate()-1);
      s = (last === y.toISOString().slice(0,10)) ? s+1 : 1;
      localStorage.setItem('talalog.streak', s);
      localStorage.setItem('talalog.lastActive', today);
    }
    qs('#streakPill').textContent = `🔥 ${s}`;
  }
  async function updateDuePill(){
    const { data:{session} } = await client.auth.getSession(); if(!session) return;
    const now = new Date().toISOString();
    const { count, error } = await client.from('words').select('id',{count:'exact',head:true})
      .eq('user_id', session.user.id).lte('next_review_at', now);
    if(!error){ qs('#duePill').textContent = `Pendientes ${count||0}`; qs('#dueInfo').textContent = `${count||0} para repasar`; }
  }
  async function updateCounters(){ updateTodayPill(); bumpStreakIfNeeded(); await updateDuePill(); }

  /* ===== OTP ===== */
  qs('#sendOtpBtn').onclick = async () => {
    const email = qs('#email').value.trim();
    if (!email) return showToast('Poné tu correo','error');
    const { error } = await client.auth.signInWithOtp({ email });
    if (error) return showToast(error.message,'error');
    showToast('Código enviado. Revisá tu email.');
  };
  qs('#verifyBtn').onclick = async () => {
    const email = qs('#email').value.trim();
    const token = qs('#otp').value.trim();
    if (!email || !token) return showToast('Correo y código','error');
    const { error } = await client.auth.verifyOtp({ email, token, type: 'email' });
    if (error) return showToast(error.message,'error');
    await onAuthed();
  };
  qs('#signOutBtn').onclick = async () => { await client.auth.signOut(); location.reload(); };

  async function onAuthed() {
    const { data: { user } } = await client.auth.getUser();
    userEmailEl.textContent = user?.email || '';
    authSection.classList.add('hidden');
    userBox.classList.remove('hidden');
    appSection.classList.remove('hidden');
    await loadWords();
    await updateCounters();
  }

  /* ===== Guardar palabra ===== */
  qs('#addBtn').onclick = addWord;
  async function addWord() {
    const term     = qs('#term').value.trim();
    const meaning  = qs('#meaning').value.trim();
    const example  = qs('#example').value.trim();
    const notes    = qs('#notes').value.trim();
    const tagsRaw  = qs('#tags').value.trim();
    const tags     = tagsRaw ? tagsRaw.split(',').map(s => s.trim()).filter(Boolean) : null;
    if (!term || !meaning) return showToast('Palabra y significado son obligatorios','error');

    const { data: { session } } = await client.auth.getSession();
    if (!session) return showToast('Iniciá sesión','error');

    const row = {
      user_id: session.user.id,
      term, meaning,
      example: example || null,
      notes: notes || null,
      tags,
      from_lang: qs('#fromLang').value,
      to_lang:   qs('#toLang').value,
      ease: 2.5, repetitions: 0, interval_days: 0,
      next_review_at: new Date().toISOString()
    };

    const { error } = await client.from('words').insert(row).select().single();
    if (error) { console.error(error); return showToast('No se pudo guardar: ' + error.message,'error'); }

    ['#term','#meaning','#example','#notes','#tags'].forEach(id => qs(id).value = '');
    showToast('Palabra agregada');
    await loadWords();
    await updateCounters();
  }

  /* ===== Entrada rápida ===== */
  qs('#quickBtn').onclick = ()=> qs('#bulkBox').classList.toggle('hidden');
  qs('#bulkAdd').onclick = async ()=>{
    const { data:{session} } = await client.auth.getSession(); if(!session) return showToast('Iniciá sesión','error');
    const lines = qs('#bulkTxt').value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!lines.length) return;
    const now = new Date().toISOString();
    const rows = lines.map(L=>{
      const [t,m] = L.split(/\s*-\s*/);
      return {user_id:session.user.id, term:t||'', meaning:m||'', example:null, notes:null, tags:['bulk'],
              from_lang:'Tagalog', to_lang:'Spanish', ease:2.5, repetitions:0, interval_days:0, next_review_at:now}
    }).filter(r=>r.term && r.meaning);
    if(!rows.length) return showToast('Formato: palabra - significado','error');
    const { error } = await client.from('words').insert(rows);
    if(error) return showToast(error.message,'error');
    qs('#bulkTxt').value='';
    showToast(`Agregadas ${rows.length}`);
    await loadWords();
    await updateCounters();
  };

  /* ===== Listar / buscar / ordenar ===== */
  qs('#search').oninput = debounce(()=>loadWords(), 250);
  qs('#sort').onchange  = () => loadWords();

  async function loadWords() {
    const { data: { session } } = await client.auth.getSession();
    if (!session) return;
    const q = qs('#search').value.trim();
    const [col, dir] = (qs('#sort').value || 'created_at.desc').split('.');

    let query = client.from('words')
      .select('*')
      .eq('user_id', session.user.id)
      .order(col, { ascending: dir !== 'desc' })
      .limit(500);

    if (q) query = query.or(`term.ilike.%${q}%,meaning.ilike.%${q}%`);

    const { data, error } = await query;
    if (error) { console.error(error); return showToast(error.message,'error'); }
    renderList(data || []);
    toggleEmptyHero(!(data && data.length));
  }

  function toggleEmptyHero(show){
    const el = qs('#emptyHero'); if(!el) return;
    el.classList[show?'remove':'add']('hidden');
  }

  /* ===== Barra “frescura” ===== */
  function freshnessPct(row){
    const last = new Date(row.last_review_at || row.created_at);
    const now  = new Date();
    const daysSince = (now - last) / 86400000;
    const targetDays = Math.max(1, row.interval_days || 1);
    const left = Math.max(0, 1 - (daysSince / targetDays));
    return Math.round(left * 100);
  }

  // Edit modal state
  let editRow = null;

  function renderList(rows) {
    countEl.textContent = `${rows.length} palabra(s)`;
    listEl.innerHTML = '';
    if (!rows.length) { listEl.innerHTML = '<div class="muted">No hay resultados. Agregá tu primera palabra 🫰</div>'; return; }

    rows.forEach(r => {
      const pct = freshnessPct(r);
      const stateClass = pct > 60 ? 'is-ok' : pct > 25 ? 'is-warn' : 'is-due';
      const div = document.createElement('div');
      div.className = `list-item card ${stateClass}`;
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(r.term)}</strong>
          <div class="muted">${escapeHtml(r.example||'')}</div>
          <div class="progress"><i style="--pct:${pct}%"></i></div>
        </div>
        <div>
          ${escapeHtml(r.meaning||'')}
          <div>${(r.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
        </div>
        <div class="right">
          <button class="btn" onclick="openEdit('${r.id}')">Editar</button>
          <button class="btn" onclick="delWord('${r.id}')">Eliminar</button>
        </div>`;
      listEl.appendChild(div);
    });
  }

  window.delWord = async (id) => {
    const { error } = await client.from('words').delete().eq('id', id);
    if (error) { console.error(error); return showToast(error.message,'error'); }
    showToast('Eliminado');
    await loadWords();
    await updateCounters();
  };

  /* ===== Editar ===== */
  window.openEdit = async (id)=>{
    const { data, error } = await client.from('words').select('*').eq('id', id).single();
    if(error) return showToast(error.message,'error');
    editRow = data;
    qs('#e_term').value = data.term||'';
    qs('#e_meaning').value = data.meaning||'';
    qs('#e_example').value = data.example||'';
    qs('#e_notes').value = data.notes||'';
    qs('#e_tags').value = (data.tags||[]).join(', ');
    qs('#editModal').style.display='flex';
  };
  qs('#e_cancel').onclick = ()=>{ qs('#editModal').style.display='none'; editRow=null; };
  qs('#e_save').onclick = async ()=>{
    if(!editRow) return;
    const updates = {
      term: qs('#e_term').value.trim(),
      meaning: qs('#e_meaning').value.trim(),
      example: qs('#e_example').value.trim()||null,
      notes: qs('#e_notes').value.trim()||null,
      tags: (qs('#e_tags').value.split(',').map(s=>s.trim()).filter(Boolean) || null)
    };
    const { error } = await client.from('words').update(updates).eq('id', editRow.id);
    if(error) return showToast(error.message,'error');
    qs('#editModal').style.display='none'; editRow=null;
    showToast('Actualizado');
    await loadWords();
  };

  /* ===== Vacío: añadir ejemplos ===== */
  qs('#addExamplesBtn')?.addEventListener('click', addExamples);
  async function addExamples(){
    const { data:{session} } = await client.auth.getSession(); if(!session) return showToast('Iniciá sesión','error');
    const now = new Date().toISOString();
    const samples = [
      {term:'kape',   meaning:'café'},
      {term:'tubig',  meaning:'agua'},
      {term:'salamat',meaning:'gracias'},
      {term:'oo',     meaning:'sí'},
      {term:'hindi',  meaning:'no'}
    ].map(r=>({
      user_id:session.user.id, ...r, example:null, notes:null, tags:['basics'],
      from_lang:'Tagalog', to_lang:'Spanish', ease:2.5, repetitions:0, interval_days:0, next_review_at:now
    }));
    const { error } = await client.from('words').insert(samples);
    if(error) return showToast(error.message,'error');
    showToast('Ejemplos agregados');
    await loadWords();
    await updateCounters();
  }

  /* ===== Exportar CSV ===== */
  qs('#exportBtn').onclick = async () => {
    const { data: { session } } = await client.auth.getSession(); if (!session) return;
    const { data, error } = await client.from('words').select('*').eq('user_id', session.user.id);
    if (error) return showToast(error.message,'error');
    const rows = data || [];
    const csv = ['term,meaning,example,notes,tags,from_lang,to_lang,created_at']
      .concat(rows.map(r => [
        r.term, r.meaning, r.example||'', r.notes||'', (r.tags||[]).join('|'), r.from_lang||'', r.to_lang||'', r.created_at
      ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='talalog.csv'; a.click(); URL.revokeObjectURL(url);
  };

  /* ===== Repaso (SM-2) ===== */
  let reviewQueue=[], current=null, reviewed=0;
  const reviewBtn = qs('#reviewBtn');
  qs('#showAnsBtn').onclick = () => qs('#revAnswer').classList.toggle('hidden');
  document.querySelectorAll('#reviewCard [data-q]').forEach(b=>b.onclick=()=>gradeCard(+b.dataset.q));
  reviewBtn.onclick = startReview;

  async function startReview() {
    const { data: { session } } = await client.auth.getSession(); if (!session) return;
    reviewBtn.disabled = true; const old = reviewBtn.textContent; reviewBtn.textContent='Cargando…';

    const now = new Date().toISOString();
    let { data, error } = await client.from('words')
      .select('*').eq('user_id', session.user.id)
      .lte('next_review_at', now)
      .order('next_review_at', { ascending:true });

    if (error){ showToast(error.message,'error'); reviewBtn.disabled=false; reviewBtn.textContent=old; return; }

    reviewQueue = data || [];

    // Plan B: si no hay vencidas, armamos repaso ligero con las 10 más antiguas
    if (!reviewQueue.length){
      const alt = await client.from('words').select('*').eq('user_id', session.user.id)
        .order('next_review_at',{ascending:true}).limit(10);
      if(!alt.error && alt.data?.length){
        reviewQueue = alt.data;
        showToast('No había tarjetas vencidas. Modo repaso ligero.');
      }else{
        showToast('Nada para hoy. ¡Agregá o practicá mañana!');
        reviewBtn.disabled=false; reviewBtn.textContent=old; return;
      }
    }

    reviewed = 0;
    qs('#dueInfo').textContent = `${reviewQueue.length} para repasar`;
    nextCard();

    reviewBtn.disabled=false; reviewBtn.textContent=old;
  }

  function nextCard() {
    current = reviewQueue.shift();
    if (!current) {
      qs('#reviewCard').classList.add('hidden');
      qs('#dueInfo').textContent = `${reviewQueue.length} para repasar`;
      showToast('¡Repaso listo!');
      updateCounters();
      return;
    }
    reviewed++;
    qs('#revPos').textContent = `${reviewed}`;
    qs('#revTerm').textContent = current.term;
    qs('#revHint').textContent = (current.from_lang||'Tagalog')+' → '+(current.to_lang||'Spanish');
    qs('#revMeaning').textContent = current.meaning||'';
    qs('#revExample').textContent = current.example||'';
    qs('#revAnswer').classList.add('hidden');
    qs('#reviewCard').classList.remove('hidden');
  }

  function sm2(prevEase=2.5, prevInterval=0, prevReps=0, q=3){
    let EF = prevEase, reps = prevReps, I = prevInterval;
    if (q < 3) { reps = 0; I = 1; }
    else {
      if (reps === 0) I = 1;
      else if (reps === 1) I = 6;
      else I = Math.round(I * EF);
      reps += 1;
      EF = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
      if (EF < 1.3) EF = 1.3;
    }
    return { EF, I, reps };
  }

  async function gradeCard(quality) {
    if (!current) return;
    const { EF, I, reps } = sm2(current.ease||2.5, current.interval_days||0, current.repetitions||0, quality);
    const next = new Date(); next.setDate(next.getDate() + (I||1));
    const updates = {
      ease: EF, interval_days: I, repetitions: reps,
      last_review_at: new Date().toISOString(),
      next_review_at: next.toISOString()
    };
    const { error } = await client.from('words').update(updates).eq('id', current.id);
    if (error) { console.error(error); return showToast('No pude actualizar: '+error.message,'error'); }
    if (quality >= 3) incToday(1);
    await loadWords();     // refresca barra
    nextCard();
  }

  // Atajos de teclado
  document.addEventListener('keydown',(e)=>{
    const card = qs('#reviewCard');
    if(!card || card.classList.contains('hidden')) return;
    if(e.code==='Space'){ e.preventDefault(); qs('#revAnswer').classList.toggle('hidden'); return; }
    if(e.key==='j'||e.key==='J'){ gradeCard(0); return; }
    if(e.key==='k'||e.key==='K'){ gradeCard(3); return; }
    if(e.key==='l'||e.key==='L'){ gradeCard(5); return; }
    if(e.key==='Escape'){ card.classList.add('hidden'); return; }
  });

  /* Auto-login si ya hay sesión */
  client.auth.getSession().then(({data:{session}})=>{ if (session) onAuthed(); });
  </script>

  <footer class="credits">Gawa ni Harry</footer>
</body>
</html>
