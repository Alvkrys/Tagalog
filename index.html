<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TalaLog — Vocabulario Tagalog</title>
  <style>
    /* ===== Paleta clara y tranquila (menta + lavanda) ===== */
    :root{
      --bg:#f7faf9;        /* fondo muy claro */
      --panel:#ffffff;     /* tarjetas y paneles */
      --ink:#0f172a;       /* texto principal */
      --muted:#64748b;     /* texto secundario */
      --bd:#e5e7eb;        /* bordes sutiles */

      --brand:#34d399;     /* menta (primario) */
      --brand-2:#a78bfa;   /* lavanda (complemento) */

      --progress-bg:#e8eef1; /* fondo de barra */

      --ok:#22c55e20;      /* halos opcionales */
      --warn:#f59e0b20;
      --due:#ef444420;

      --shadow: 0 10px 24px rgba(16,24,40,.08);
      --radius: 12px;
    }

    body{
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
      margin:24px;
    }
    /* Layout principal: 1 columna en móvil; 2 columnas en desktop */
    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      max-width:1200px;
      margin:0 auto;
    }
    @media (min-width:980px){
      .layout{ grid-template-columns: minmax(0,1fr) 340px; }
    }

    header{
      display:flex; align-items:center; gap:16px; justify-content:space-between;
      max-width:1200px; margin:0 auto 16px auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; font-size:28px;
    }
    .flag{ font-size:28px; vertical-align:-2px }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--bd); padding:6px 10px; border-radius:999px;
      color:var(--muted); background:#fff; font-size:14px;
    }
    .chip .dot{ width:8px; height:8px; border-radius:50%; background:var(--brand); display:inline-block }

    input,button,textarea,select{
      padding:10px;border:1px solid var(--bd);border-radius:10px;margin:4px 0;background:#fff
    }
    button{cursor:pointer;background:#fff;transition:.15s ease}
    button:hover{transform:translateY(-1px)}
    .primary{background:var(--brand);color:#fff;border-color:transparent}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:728px){.grid{grid-template-columns:1fr}}

    .card{
      background: radial-gradient(120% 120% at 100% 0%, rgba(167,139,250,.10), rgba(255,255,255,.92) 60%), var(--panel);
      border:1px solid var(--bd);
      border-radius:var(--radius);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: color-mix(in oklab, var(--brand) 40%, var(--bd));
      background: radial-gradient(120% 120% at 100% 0%, rgba(52,211,153,.08), rgba(255,255,255,.95) 60%), var(--panel);
    }

    /* Lista */
    .list-item{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}
    @media(max-width:728px){ .list-item{grid-template-columns:1fr; } }

    /* Barra de progreso lineal */
    .progress{height:6px;background:var(--progress-bg);border-radius:999px;overflow:hidden;margin-top:6px}
    .progress > i{display:block;height:100%;width:var(--pct,0%);background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .4s ease;border-radius:inherit}

    /* Estados por frescura */
    .card.is-ok{box-shadow:0 0 0 6px var(--ok) inset}
    .card.is-warn{box-shadow:0 0 0 6px var(--warn) inset}
    .card.is-due{box-shadow:0 0  0 6px var(--due) inset}

    /* Efecto de texto en hover (sutil) */
    .list-item:hover strong{
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      -webkit-background-clip:text;background-clip:text;color:transparent
    }

    /* ===== Sidebar Coach ===== */
    aside .aside-card{ padding:14px; border:1px solid var(--bd); border-radius:var(--radius); background:#fff; box-shadow: var(--shadow); }
    .ring-wrap{ display:flex; gap:12px; align-items:center; }
    .ring{
      --p:0; /* porcentaje (0–100) */
      width:88px; height:88px; border-radius:50%;
      background:
        radial-gradient(circle at 50% 50%, #fff 60%, transparent 61%),
        conic-gradient(var(--brand) calc(var(--p)*1%), var(--progress-bg) 0);
      box-shadow: inset 0 0 0 1px var(--bd);
      display:grid; place-items:center;
      font-weight:700; color:var(--ink);
    }
    .ring small{ display:block; font-weight:600; color:var(--muted); font-size:12px }
    .aside-title{ font-weight:700; margin-bottom:6px }
    .aside-sub{ color:var(--muted); font-size:14px; }

    .pack{ border:1px dashed var(--bd); padding:10px; border-radius:10px; margin:8px 0; }
    .pack strong{ display:block }
    .pack .preview{ color:var(--muted); font-size:14px }

    /* Toasts */
    #toast{ position:fixed; right:20px; bottom:20px; display:flex; flex-direction:column; gap:8px; z-index:9999;}
    .toast{ background:#fff; border:1px solid var(--bd); border-left:4px solid var(--brand); padding:10px 12px; border-radius:10px;
            box-shadow:var(--shadow); color:var(--ink); min-width:220px; transition:.3s ease;}
    .toast.error{ border-left-color:#ef4444;}

    /* Footer crédito */
    .credits{ text-align:center; color:#d4af37; font-size:12px; margin:28px 0 8px; opacity:.9; }
  </style>
</head>
<body>
  <div id="toast" aria-live="polite"></div>

  <!-- ============ HEADER ============ -->
  <header>
    <div class="brand">
      <span class="flag" aria-label="Bandera de Filipinas">🇵🇭</span>
      TalaLog
    </div>

    <div class="row">
      <span class="chip" id="chipToday"><span class="dot"></span> Hoy <b id="chipTodayCount">0</b>/<b id="chipGoal">20</b></span>
      <span class="chip" id="chipDue"><span class="dot"></span> Pendientes <b id="chipDueCount">0</b></span>
      <span class="chip" id="chipStreak">🔥 <b id="chipStreakCount">0</b></span>
      <span id="userEmail" class="muted"></span>
      <button id="signOutBtn">Salir</button>
    </div>
  </header>

  <!-- ============ LAYOUT ============ -->
  <div class="layout">
    <!-- ===== MAIN ===== -->
    <main>
      <!-- === Auth (OTP) === -->
      <section id="authSection" class="card">
        <h3>Entrá con tu correo (OTP)</h3>
        <div class="row">
          <input id="email" placeholder="tu@correo.com" style="min-width:260px">
          <button id="sendOtpBtn">Enviar código</button>
        </div>
        <div class="row">
          <input id="otp" placeholder="Código de 6 dígitos" style="min-width:260px">
          <button id="verifyBtn">Verificar</button>
        </div>
        <p class="muted">Revisá tu inbox/spam. El código caduca pronto.</p>
      </section>

      <!-- === App === -->
      <section id="appSection" class="hidden">
        <div class="card">
          <h3>Agregar palabra</h3>
          <div class="grid">
            <input id="term"    placeholder="Palabra en Tagalog *">
            <input id="meaning" placeholder="Significado (ES/EN)">
            <input id="example" placeholder="Ejemplo de uso">
            <input id="tags"    placeholder="Etiquetas: saludo,verbo (coma separadas)">
          </div>
          <div class="grid">
            <input id="notes" placeholder="Notas">
            <div class="row">
              <select id="fromLang"><option>Tagalog</option><option>English</option><option>Spanish</option></select>
              <select id="toLang"><option>Spanish</option><option>English</option></select>
              <button class="primary" id="addBtn">Agregar</button>
              <button id="exportBtn">Exportar CSV</button>
            </div>
          </div>
          <div class="row">
            <input id="search" placeholder="Buscar..." style="flex:1">
            <select id="sort">
              <option value="created_at.desc">Recientes primero</option>
              <option value="term.asc">A–Z</option>
              <option value="term.desc">Z–A</option>
              <option value="updated_at.desc">Editadas reciente</option>
            </select>
            <span class="muted" id="countLabel"></span>
          </div>
        </div>

        <div id="list" class="card"></div>

        <div class="row">
          <button class="primary" id="reviewBtn">Repasar hoy</button>
          <span id="dueInfo" class="muted"></span>
        </div>

        <div id="reviewCard" class="card hidden">
          <div class="muted">Tarjeta <span id="revPos">0</span></div>
          <h2 id="revTerm" style="margin:8px 0 4px 0"></h2>
          <div id="revHint" class="muted"></div>
          <button id="showAnsBtn">Mostrar significado</button>
          <div id="revAnswer" class="hidden" style="margin-top:8px">
            <strong id="revMeaning"></strong>
            <div id="revExample" class="muted" style="margin-top:4px"></div>
          </div>
          <div class="row">
            <button data-q="0">Again</button>
            <button data-q="3">Good</button>
            <button data-q="5">Easy</button>
          </div>
        </div>
      </section>
    </main>

    <!-- ===== ASIDE (COACH) ===== -->
    <aside id="coachAside" class="hidden">
      <!-- Coach -->
      <div class="aside-card">
        <div class="aside-title">Coach</div>
        <div class="ring-wrap">
          <div class="ring" id="ring" style="--p:0">
            <div><span id="ringToday">0</span>/<span id="ringGoal">20</span><small>hoy</small></div>
          </div>
          <div>
            <div class="aside-sub">Racha: 🔥 <b id="asideStreak">0</b></div>
            <div class="aside-sub">Pendientes: <b id="asideDue">0</b></div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="asideReviewBtn">Repasar ahora</button>
          <button id="addExamplesBtn">Añadir ejemplos</button>
        </div>
      </div>

      <!-- Frase del día -->
      <div class="aside-card" id="dailyCard" style="margin-top:12px">
        <div class="aside-title">Frase del día</div>
        <div id="dailyPhrase">
          <strong id="dailyTerm">Salamat po</strong>
          <div class="muted" id="dailyMeaning">Gracias (formal)</div>
          <div class="muted" id="dailyExample" style="margin-top:4px">Salamat po sa tulong.</div>
        </div>
        <div class="row">
          <button id="dailyAddBtn" class="primary">Añadir a mis palabras</button>
        </div>
      </div>

      <!-- Paquetes -->
      <div class="aside-card" style="margin-top:12px">
        <div class="aside-title">Paquetes recomendados</div>
        <div id="packs"></div>
      </div>
    </aside>
  </div>

  <footer class="credits">Gawa ni Harry</footer>

  <!-- ============ SCRIPTS ============ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ===== Supabase: tus claves ===== */
    const SUPABASE_URL = "https://wszrttutzsmzayzpbnjq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzenJ0dHV0enNtemF5enBibmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODI4MzAsImV4cCI6MjA3MTE1ODgzMH0.2Xkc4vCPbJ1W9Sbp78Ae_qvKZHC_GP8Dtq4Ub6ZZW1M";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== Helpers DOM ===== */
    const qs = s => document.querySelector(s);
    const authSection = qs('#authSection');
    const appSection  = qs('#appSection');
    const userEmailEl = qs('#userEmail');
    const listEl      = qs('#list');
    const countEl     = qs('#countLabel');

    /* ===== Local state (meta diaria, racha) ===== */
    const GOAL = Number(localStorage.getItem('goal')||20);
    const todayKey = () => new Date().toISOString().slice(0,10);
    function getTodayCount(){
      const k = localStorage.getItem('todayKey');
      if (k !== todayKey()) { localStorage.setItem('todayKey', todayKey()); localStorage.setItem('todayCount','0'); }
      return Number(localStorage.getItem('todayCount')||0);
    }
    function incToday(count=1){
      const k = localStorage.getItem('todayKey');
      if (k !== todayKey()) { localStorage.setItem('todayKey', todayKey()); localStorage.setItem('todayCount','0'); }
      const v = getTodayCount() + count;
      localStorage.setItem('todayCount', String(v));
      updateCoachUI();
    }
    function getStreak(){
      const last = localStorage.getItem('lastPracticeDate');
      const today = todayKey();
      // si no hay last -> 0
      let streak = Number(localStorage.getItem('streak')||0);
      if (last && last !== today){
        const d1 = new Date(last); const d2 = new Date(today);
        const diff = Math.round((d2 - d1)/86400000);
        if (diff === 1) { /* continúa */ }
        else if (diff > 1) { streak = 0; localStorage.setItem('streak','0'); }
      }
      return streak;
    }
    function bumpStreakIfNeeded(){
      const last = localStorage.getItem('lastPracticeDate');
      const today = todayKey();
      if (last !== today){
        // Primer práctica del día -> incrementar racha
        const s = getStreak()+1;
        localStorage.setItem('streak', String(s));
        localStorage.setItem('lastPracticeDate', today);
      }
      updateCoachUI();
    }

    /* ===== Toast ===== */
    function toast(msg, type='info'){
      const box = qs('#toast');
      const el = document.createElement('div');
      el.className = 'toast'+(type==='error'?' error':'');
      el.textContent = msg;
      box.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2500);
      setTimeout(()=>{ box.removeChild(el); }, 3200);
    }

    /* ===== OTP Login ===== */
    qs('#sendOtpBtn').onclick = async () => {
      const email = qs('#email').value.trim();
      if (!email) return toast('Poné tu correo','error');
      const { error } = await client.auth.signInWithOtp({ email });
      if (error) return toast(error.message,'error');
      toast('Código enviado. Revisá tu email.');
    };
    qs('#verifyBtn').onclick = async () => {
      const email = qs('#email').value.trim();
      const token = qs('#otp').value.trim();
      if (!email || !token) return toast('Correo y código','error');
      const { error } = await client.auth.verifyOtp({ email, token, type: 'email' });
      if (error) return toast(error.message,'error');
      await onAuthed();
    };
    qs('#signOutBtn').onclick = async () => { await client.auth.signOut(); location.reload(); };

    async function onAuthed() {
      const { data: { user } } = await client.auth.getUser();
      userEmailEl.textContent = user?.email || '';
      authSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      qs('#coachAside').classList.remove('hidden');
      await loadWords();
      updateCoachUI();
      loadDaily();
      renderPacks();
    }

    /* ===== Guardar palabra ===== */
    qs('#addBtn').onclick = addWord;
    async function addWord() {
      const term     = qs('#term').value.trim();
      const meaning  = qs('#meaning').value.trim();
      const example  = qs('#example').value.trim();
      const notes    = qs('#notes').value.trim();
      const tagsRaw  = qs('#tags').value.trim();
      const tags     = tagsRaw ? tagsRaw.split(',').map(s => s.trim()).filter(Boolean) : null;
      if (!term || !meaning) return toast('Palabra y significado son obligatorios','error');

      const { data: { session } } = await client.auth.getSession();
      if (!session) return toast('Iniciá sesión','error');

      const row = {
        user_id: session.user.id,
        term, meaning,
        example: example || null,
        notes: notes || null,
        tags,
        from_lang: qs('#fromLang').value,
        to_lang:   qs('#toLang').value,
        ease: 2.5, repetitions: 0, interval_days: 0,
        next_review_at: new Date().toISOString()
      };

      const { error } = await client.from('words').insert(row).select().single();
      if (error) { console.error(error); return toast('No se pudo guardar: ' + error.message,'error'); }

      ['#term','#meaning','#example','#notes','#tags'].forEach(id => qs(id).value = '');
      toast('Guardado ✓');
      await loadWords();
    }

    /* ===== Listar / buscar / ordenar ===== */
    qs('#search').oninput = () => loadWords();
    qs('#sort').onchange  = () => loadWords();

    async function loadWords() {
      const { data: { session } } = await client.auth.getSession();
      if (!session) return;
      const q = qs('#search').value.trim();
      const [col, dir] = (qs('#sort').value || 'created_at.desc').split('.');

      let query = client.from('words')
        .select('*')
        .eq('user_id', session.user.id)
        .order(col, { ascending: dir !== 'desc' })
        .limit(500);

      if (q) query = query.or(`term.ilike.%${q}%,meaning.ilike.%${q}%`);

      const { data, error } = await query;
      if (error) { console.error(error); return toast(error.message,'error'); }
      renderList(data || []);
      await computeDueCount();
    }

    /* Barra de frescura (lineal por día) */
    function freshnessPct(row){
      const last = new Date(row.last_review_at || row.created_at);
      const now  = new Date();
      const daysSince = (now - last) / 86400000;
      const targetDays = Math.max(1, row.interval_days || 1);
      const left = Math.max(0, 1 - (daysSince / targetDays));
      return Math.round(left * 100);
    }

    function renderList(rows) {
      countEl.textContent = `${rows.length} palabra(s)`;
      listEl.innerHTML = '';
      if (!rows.length) { listEl.innerHTML = '<div class="muted">No hay resultados. Agregá tu primera palabra 🫰</div>'; return; }

      rows.forEach(r => {
        const pct = freshnessPct(r);
        const stateClass = pct > 60 ? 'is-ok' : pct > 25 ? 'is-warn' : 'is-due';

        const div = document.createElement('div');
        div.className = `list-item card ${stateClass}`;
        div.innerHTML = `
          <div>
            <strong>${escapeHtml(r.term)}</strong>
            <div class="muted">${escapeHtml(r.example||'')}</div>
            <div class="progress"><i style="--pct:${pct}%"></i></div>
          </div>
          <div>
            ${escapeHtml(r.meaning||'')}
            <div>${(r.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
          </div>
          <div class="right">
            <button onclick="delWord('${r.id}')">Eliminar</button>
          </div>`;
        listEl.appendChild(div);
      });
    }
    window.delWord = async (id) => {
      const { error } = await client.from('words').delete().eq('id', id);
      if (error) { console.error(error); return toast(error.message,'error'); }
      toast('Eliminado');
      await loadWords();
    };

    /* ===== Exportar CSV ===== */
    qs('#exportBtn').onclick = async () => {
      const { data: { session } } = await client.auth.getSession(); if (!session) return;
      const { data, error } = await client.from('words').select('*').eq('user_id', session.user.id);
      if (error) return toast(error.message,'error');
      const rows = data || [];
      const csv = ['term,meaning,example,notes,tags,from_lang,to_lang,created_at']
        .concat(rows.map(r => [
          r.term, r.meaning, r.example||'', r.notes||'', (r.tags||[]).join('|'), r.from_lang||'', r.to_lang||'', r.created_at
        ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='talalog.csv'; a.click(); URL.revokeObjectURL(url);
    };

    /* ===== Repaso (SM-2) ===== */
    let reviewQueue=[], current=null, reviewed=0;
    qs('#reviewBtn').onclick = startReview;
    qs('#asideReviewBtn').onclick = startReview;
    qs('#showAnsBtn').onclick = () => qs('#revAnswer').classList.toggle('hidden');
    document.querySelectorAll('#reviewCard [data-q]').forEach(b=>b.onclick=()=>gradeCard(+b.dataset.q));

    async function startReview() {
      const { data: { session } } = await client.auth.getSession(); if (!session) return;
      const now = new Date().toISOString();
      const { data, error } = await client.from('words')
        .select('*').eq('user_id', session.user.id)
        .lte('next_review_at', now)
        .order('next_review_at', { ascending:true });
      if (error) return toast(error.message,'error');
      reviewQueue = data || []; reviewed = 0;

      qs('#dueInfo').textContent = `${reviewQueue.length} para repasar`;
      if (!reviewQueue.length){ toast('Nada para repasar. ¡Agregá palabras o espera al próximo intervalo!'); return; }

      nextCard();
    }
    function nextCard() {
      current = reviewQueue.shift();
      if (!current) {
        qs('#reviewCard').classList.add('hidden');
        qs('#dueInfo').textContent = `${reviewQueue.length} para repasar`;
        toast('¡Repaso listo! 🎉');
        computeDueCount(); // refresca pendientes
        return;
      }
      reviewed++;
      qs('#revPos').textContent = `${reviewed}`;
      qs('#revTerm').textContent = current.term;
      qs('#revHint').textContent = (current.from_lang||'Tagalog')+' → '+(current.to_lang||'Spanish');
      qs('#revMeaning').textContent = current.meaning||'';
      qs('#revExample').textContent = current.example||'';
      qs('#revAnswer').classList.add('hidden');
      qs('#reviewCard').classList.remove('hidden');
    }

    function sm2(prevEase=2.5, prevInterval=0, prevReps=0, q=3){
      let EF = prevEase, reps = prevReps, I = prevInterval;
      if (q < 3) { reps = 0; I = 1; }
      else {
        if (reps === 0) I = 1;
        else if (reps === 1) I = 6;
        else I = Math.round(I * EF);
        reps += 1;
        EF = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
        if (EF < 1.3) EF = 1.3;
      }
      return { EF, I, reps };
    }
    async function gradeCard(quality) {
      if (!current) return;
      const { EF, I, reps } = sm2(current.ease||2.5, current.interval_days||0, current.repetitions||0, quality);
      const next = new Date(); next.setDate(next.getDate() + (I||1));
      const updates = {
        ease: EF, interval_days: I, repetitions: reps,
        last_review_at: new Date().toISOString(),
        next_review_at: next.toISOString()
      };
      const { error } = await client.from('words').update(updates).eq('id', current.id);
      if (error) { console.error(error); return toast('No pude actualizar: '+error.message,'error'); }

      // Contabilizar progreso del día y racha (solo si Good/Easy)
      if (quality >= 3) { incToday(1); bumpStreakIfNeeded(); }

      await loadWords();     // refresca barras
      nextCard();
    }

    /* ===== Coach UI ===== */
    async function computeDueCount(){
      const { data: { session } } = await client.auth.getSession(); if (!session) return 0;
      const now = new Date().toISOString();
      const { count, error } = await client.from('words')
        .select('id', { count: 'exact', head: true })
        .eq('user_id', session.user.id).lte('next_review_at', now);
      if (error) { console.error(error); return 0; }
      const n = count || 0;
      qs('#chipDueCount').textContent = n;
      const ad = qs('#asideDue'); if (ad) ad.textContent = n;
      return n;
    }
    function updateCoachUI(){
      // hoy / meta
      const today = getTodayCount();
      const goal = GOAL;
      const pct = Math.min(100, Math.round((today/goal)*100));
      qs('#chipTodayCount').textContent = today;
      qs('#chipGoal').textContent = goal;
      const ring = qs('#ring'); if (ring) ring.style.setProperty('--p', pct);
      const ringToday = qs('#ringToday'); if (ringToday) ringToday.textContent = today;
      const ringGoal = qs('#ringGoal'); if (ringGoal) ringGoal.textContent = goal;

      // racha
      const s = getStreak();
      qs('#chipStreakCount').textContent = s;
      const as = qs('#asideStreak'); if (as) as.textContent = s;
    }

    /* ===== Frase del día + Packs ===== */
    const PACKS = {
      restaurante: [
        { term:'mesa', meaning:'mesa', example:'Libre ba ang mesa dito?' },
        { term:'menu', meaning:'menú', example:'Puwede po bang makita ang menu?' },
        { term:'tubig', meaning:'agua', example:'Pahingi po ng tubig.' },
        { term:'bayad', meaning:'pagar', example:'Magbabayad na po kami.' },
        { term:'masarap', meaning:'rico/delicioso', example:'Masarap ang ulam!' },
        { term:'kutsara at tinidor', meaning:'cuchara y tenedor', example:'May kutsara at tinidor po ba?' },
      ],
      conociendo: [
        { term:'Kumusta?', meaning:'¿Cómo estás?', example:'Kumusta? Okay ka lang?' },
        { term:'Ako si Harry', meaning:'Soy Harry', example:'Ako si Harry. Ikaw?' },
        { term:'Taga-saan ka?', meaning:'¿De dónde eres?', example:'Taga-saan ka?' },
        { term:'Ilan taon ka na?', meaning:'¿Cuántos años tienes?', example:'Ilan taon ka na?' },
        { term:'Anong trabaho mo?', meaning:'¿A qué te dedicas?', example:'Anong trabaho mo?' },
      ],
      entrevista: [
        { term:'karanasan', meaning:'experiencia', example:'May karanasan po ako sa marketing.' },
        { term:'malakas sa team', meaning:'buen jugador de equipo', example:'Malakas po ako sa team.' },
        { term:'layunin', meaning:'objetivo', example:'Ang layunin ko ay matuto at tumulong.' },
        { term:'oras', meaning:'horario', example:'Flexible po ako sa oras.' },
        { term:'inisyatibo', meaning:'iniciativa', example:'May inisyatibo po ako sa trabaho.' },
      ]
    };

    function dayIndex(){ return Math.floor(Date.now()/86400000); }
    function loadDaily(){
      // Elegimos una frase del conjunto combinado
      const all = [...PACKS.restaurante, ...PACKS.conociendo, ...PACKS.entrevista];
      const pick = all[ dayIndex() % all.length ];
      qs('#dailyTerm').textContent = pick.term;
      qs('#dailyMeaning').textContent = pick.meaning;
      qs('#dailyExample').textContent = pick.example;
      qs('#dailyAddBtn').onclick = () => addFromDaily(pick);
    }
    async function addFromDaily(item){
      const { data: { session } } = await client.auth.getSession(); if (!session) return toast('Iniciá sesión','error');
      const row = {
        user_id: session.user.id,
        term: item.term, meaning: item.meaning,
        example: item.example||null, notes: null, tags:['daily'],
        from_lang:'Tagalog', to_lang:'Spanish',
        ease:2.5, repetitions:0, interval_days:0, next_review_at:new Date().toISOString()
      };
      const { error } = await client.from('words').insert(row);
      if (error) return toast(error.message,'error');
      toast('Añadido desde “Frase del día” ✓');
      await loadWords();
    }

    function renderPacks(){
      const el = qs('#packs'); el.innerHTML='';
      const defs = [
        { key:'restaurante', title:'Restaurante' },
        { key:'conociendo', title:'Conociendo' },
        { key:'entrevista', title:'Entrevista' },
      ];
      defs.forEach(d => {
        const items = PACKS[d.key].slice(0,2).map(x=>`• ${x.term} — ${x.meaning}`).join('<br>');
        const div = document.createElement('div');
        div.className = 'pack';
        div.innerHTML = `
          <strong>${d.title}</strong>
          <div class="preview">${items}</div>
          <div class="row"><button data-key="${d.key}" class="primary">Cargar 5</button></div>
        `;
        el.appendChild(div);
      });
      el.querySelectorAll('button[data-key]').forEach(b=>{
        b.onclick = () => bulkAddPack(b.dataset.key);
      });
      qs('#addExamplesBtn').onclick = () => bulkAddPack('conociendo');
    }

    async function bulkAddPack(key){
      const { data: { session } } = await client.auth.getSession(); if (!session) return toast('Iniciá sesión','error');
      const src = PACKS[key].slice(0,5);
      const rows = src.map(x=>({
        user_id: session.user.id,
        term:x.term, meaning:x.meaning, example:x.example||null, notes:null,
        tags:[key], from_lang:'Tagalog', to_lang:'Spanish',
        ease:2.5, repetitions:0, interval_days:0, next_review_at:new Date().toISOString()
      }));
      const { error } = await client.from('words').insert(rows);
      if (error) return toast(error.message,'error');
      toast(`Se cargaron 5 de ${key} ✓`);
      await loadWords();
    }

    /* Utilidad */
    function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

    /* Auto-login si ya hay sesión */
    client.auth.getSession().then(async ({data:{session}})=>{
      if (session) { await onAuthed(); }
      else {
        // En móvil, ocultamos sidebar
        qs('#coachAside').classList.add('hidden');
      }
    });

    // Actualiza counts de entrada
    updateCoachUI();
  </script>
</body>
</html>