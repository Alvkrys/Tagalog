<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TalaLog ‚Äî Vocabulario Tagalog</title>
  <style>
    :root { --bg:#fafafa; --ink:#171717; --muted:#6b7280; --bd:#e5e7eb; --brand:#4f46e5; }
    body{font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:24px;max-width:980px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    input,button,textarea,select{padding:10px;border:1px solid var(--bd);border-radius:10px;margin:4px 0}
    button{border:1px solid var(--bd);border-radius:10px;cursor:pointer;background:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .card{border:1px solid var(--bd);padding:12px;border-radius:10px;margin:8px 0;background:#fff}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:728px){.grid{grid-template-columns:1fr}}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-right:6px}
    .list-item{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}
    .primary{background:var(--brand);color:#fff;border-color:transparent}
  </style>
</head>
<body>

<header>
  <h1>üìù TalaLog</h1>
  <div id="userBox" class="hidden">
    <span id="userEmail" class="muted"></span>
    <button id="signOutBtn">Salir</button>
  </div>
</header>

<!-- === Auth (OTP) === -->
<section id="authSection" class="card">
  <h3>Entr√° con tu correo (OTP)</h3>
  <div class="row">
    <input id="email" placeholder="tu@correo.com" style="min-width:260px">
    <button id="sendOtpBtn">Enviar c√≥digo</button>
  </div>
  <div class="row">
    <input id="otp" placeholder="C√≥digo de 6 d√≠gitos" style="min-width:260px">
    <button id="verifyBtn">Verificar</button>
  </div>
  <p class="muted">Revis√° tu inbox/spam. El c√≥digo caduca pronto.</p>
</section>

<!-- === App === -->
<section id="appSection" class="hidden">
  <div class="card">
    <h3>Agregar palabra</h3>
    <div class="grid">
      <input id="term"    placeholder="Palabra en Tagalog *">
      <input id="meaning" placeholder="Significado (ES/EN)">
      <input id="example" placeholder="Ejemplo de uso">
      <input id="tags"    placeholder="Etiquetas: saludo,verbo (coma separadas)">
    </div>
    <div class="grid">
      <input id="notes" placeholder="Notas">
      <div class="row">
        <select id="fromLang"><option>Tagalog</option><option>English</option><option>Spanish</option></select>
        <select id="toLang"><option>Spanish</option><option>English</option></select>
        <button class="primary" id="addBtn">Agregar</button>
        <button id="exportBtn">Exportar CSV</button>
      </div>
    </div>
    <div class="row">
      <input id="search" placeholder="Buscar..." style="flex:1">
      <select id="sort">
        <option value="created_at.desc">Recientes primero</option>
        <option value="term.asc">A‚ÜíZ</option>
        <option value="term.desc">Z‚ÜíA</option>
        <option value="updated_at.desc">Editadas reciente</option>
      </select>
      <span class="muted" id="countLabel"></span>
    </div>
  </div>

  <div id="list" class="card"></div>

  <div class="row">
    <button class="primary" id="reviewBtn">Repasar hoy</button>
    <span id="dueInfo" class="muted"></span>
  </div>

  <div id="reviewCard" class="card hidden">
    <div class="muted">Tarjeta <span id="revPos">0</span></div>
    <h2 id="revTerm" style="margin:8px 0 4px 0"></h2>
    <div id="revHint" class="muted"></div>
    <button id="showAnsBtn">Mostrar significado</button>
    <div id="revAnswer" class="hidden" style="margin-top:8px">
      <strong id="revMeaning"></strong>
      <div id="revExample" class="muted" style="margin-top:4px"></div>
    </div>
    <div class="row">
      <button data-q="0">Again</button>
      <button data-q="3">Good</button>
      <button data-q="5">Easy</button>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ==== CONFIG: peg√° tus claves (o dej√° las que ya ten√≠as) ====
  const SUPABASE_URL = "https://wszrttutzsmzayzpbnjq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzenJ0dHV0enNtemF5enBibmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODI4MzAsImV4cCI6MjA3MTE1ODgzMH0.2Xkc4vCPbJ1W9Sbp78Ae_qvKZHC_GP8Dtq4Ub6ZZW1M";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Helpers
  const qs = s => document.querySelector(s);
  const authSection = qs('#authSection');
  const appSection  = qs('#appSection');
  const userBox     = qs('#userBox');
  const userEmailEl = qs('#userEmail');
  const listEl      = qs('#list');
  const countEl     = qs('#countLabel');

  // === Auth (OTP) ===
  qs('#sendOtpBtn').onclick = async () => {
    const email = qs('#email').value.trim();
    if (!email) return alert('Pon√© tu correo');
    const { error } = await client.auth.signInWithOtp({ email }); // passwordless OTP
    if (error) return alert(error.message);
    alert('C√≥digo enviado. Revis√° tu email.');
  };
  qs('#verifyBtn').onclick = async () => {
    const email = qs('#email').value.trim();
    const token = qs('#otp').value.trim();
    if (!email || !token) return alert('Correo y c√≥digo');
    const { data, error } = await client.auth.verifyOtp({ email, token, type: 'email' }); // verifica OTP
    if (error) return alert(error.message);
    await onAuthed();
  };
  qs('#signOutBtn').onclick = async () => { await client.auth.signOut(); location.reload(); };

  async function onAuthed() {
    const { data: { user } } = await client.auth.getUser();
    userEmailEl.textContent = user?.email || '';
    authSection.classList.add('hidden');
    userBox.classList.remove('hidden');
    appSection.classList.remove('hidden');
    await loadWords();
  }

  // === Guardar ===
  qs('#addBtn').onclick = addWord;
  async function addWord() {
    const term     = qs('#term').value.trim();
    const meaning  = qs('#meaning').value.trim();
    const example  = qs('#example').value.trim();
    const notes    = qs('#notes').value.trim();
    const tagsRaw  = qs('#tags').value.trim();
    const tags     = tagsRaw ? tagsRaw.split(',').map(s => s.trim()).filter(Boolean) : null;
    if (!term || !meaning) return alert('Palabra y significado son obligatorios');

    const { data: { session } } = await client.auth.getSession();
    if (!session) return alert('Inici√° sesi√≥n');

    const row = {
      user_id: session.user.id,
      term, meaning,
      example: example || null,
      notes: notes || null,
      tags,
      from_lang: qs('#fromLang').value,
      to_lang:   qs('#toLang').value,
      ease: 2.5, repetitions: 0, interval_days: 0,
      next_review_at: new Date().toISOString()
    };

    const { error } = await client.from('words').insert(row).select().single();
    if (error) { console.error(error); return alert('No se pudo guardar: ' + error.message); }

    ['#term','#meaning','#example','#notes','#tags'].forEach(id => qs(id).value = '');
    await loadWords();
  }

  // === Listar / Buscar / Ordenar ===
  qs('#search').oninput = () => loadWords();
  qs('#sort').onchange  = () => loadWords();

  async function loadWords() {
    const { data: { session } } = await client.auth.getSession();
    if (!session) return;
    const q = qs('#search').value.trim();
    const [col, dir] = (qs('#sort').value || 'created_at.desc').split('.');

    let query = client.from('words')
      .select('*')
      .eq('user_id', session.user.id)
      .order(col, { ascending: dir !== 'desc' })
      .limit(500);

    if (q) query = query.or(`term.ilike.%${q}%,meaning.ilike.%${q}%`);

    const { data, error } = await query;
    if (error) { console.error(error); return alert(error.message); }
    renderList(data || []);
  }

  function renderList(rows) {
    countEl.textContent = `${rows.length} palabra(s)`;
    listEl.innerHTML = '';
    if (!rows.length) { listEl.innerHTML = '<div class="muted">No hay resultados. Agreg√° tu primera palabra ü´∞</div>'; return; }

    rows.forEach(r => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <div><strong>${escapeHtml(r.term)}</strong><div class="muted">${escapeHtml(r.example||'')}</div></div>
        <div>${escapeHtml(r.meaning||'')}<div>${(r.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div></div>
        <div class="right">
          <button onclick="delWord('${r.id}')">Eliminar</button>
        </div>`;
      listEl.appendChild(div);
    });
  }
  window.delWord = async (id) => {
    const { error } = await client.from('words').delete().eq('id', id);
    if (error) { console.error(error); return alert(error.message); }
    await loadWords();
  };

  // === Exportar CSV ===
  qs('#exportBtn').onclick = async () => {
    const { data: { session } } = await client.auth.getSession(); if (!session) return;
    const { data, error } = await client.from('words').select('*').eq('user_id', session.user.id);
    if (error) return alert(error.message);
    const rows = data || [];
    const csv = ['term,meaning,example,notes,tags,from_lang,to_lang,created_at']
      .concat(rows.map(r => [
        r.term, r.meaning, r.example||'', r.notes||'', (r.tags||[]).join('|'), r.from_lang||'', r.to_lang||'', r.created_at
      ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='talalog.csv'; a.click(); URL.revokeObjectURL(url);
  };

  // === Repaso (SM-2 simplificado) ===
  let reviewQueue=[], current=null, reviewed=0;
  qs('#reviewBtn').onclick = startReview;
  qs('#showAnsBtn').onclick = () => qs('#revAnswer').classList.toggle('hidden');
  document.querySelectorAll('#reviewCard [data-q]').forEach(b=>b.onclick=()=>gradeCard(+b.dataset.q));

  async function startReview() {
    const { data: { session } } = await client.auth.getSession(); if (!session) return;
    const now = new Date().toISOString();
    const { data, error } = await client.from('words')
      .select('*').eq('user_id', session.user.id)
      .lte('next_review_at', now)
      .order('next_review_at', { ascending:true });
    if (error) return alert(error.message);
    reviewQueue = data || []; reviewed = 0;
    qs('#dueInfo').textContent = `${reviewQueue.length} para repasar`;
    nextCard();
  }
  function nextCard() {
    current = reviewQueue.shift();
    if (!current) { qs('#reviewCard').classList.add('hidden'); alert('¬°Repaso listo!'); startReview(); return; }
    reviewed++; qs('#revPos').textContent = `${reviewed}`;
    qs('#revTerm').textContent = current.term;
    qs('#revHint').textContent = (current.from_lang||'Tagalog')+' ‚Üí '+(current.to_lang||'Spanish');
    qs('#revMeaning').textContent = current.meaning||'';
    qs('#revExample').textContent = current.example||'';
    qs('#revAnswer').classList.add('hidden');
    qs('#reviewCard').classList.remove('hidden');
  }
  function sm2(prevEase=2.5, prevInterval=0, prevReps=0, q=3){
    let EF = prevEase, reps = prevReps, I = prevInterval;
    if (q < 3) { reps = 0; I = 1; }
    else {
      if (reps === 0) I = 1;
      else if (reps === 1) I = 6;
      else I = Math.round(I * EF);
      reps += 1;
      EF = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
      if (EF < 1.3) EF = 1.3;
    }
    return { EF, I, reps };
  }
  async function gradeCard(quality) {
    if (!current) return;
    const { EF, I, reps } = sm2(current.ease||2.5, current.interval_days||0, current.repetitions||0, quality);
    const next = new Date(); next.setDate(next.getDate() + (I||1));
    const updates = {
      ease: EF, interval_days: I, repetitions: reps,
      last_review_at: new Date().toISOString(),
      next_review_at: next.toISOString()
    };
    const { error } = await client.from('words').update(updates).eq('id', current.id);
    if (error) { console.error(error); return alert('No pude actualizar: '+error.message); }
    nextCard();
  }

  // Utilidades
  function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

  // === Auto-login si ya hay sesi√≥n
  client.auth.getSession().then(({data:{session}})=>{ if (session) onAuthed(); });
</script>
</body>
</html>
