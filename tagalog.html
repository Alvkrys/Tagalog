<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PH Â· Tagalog</title>
<style>
  :root{
    --bg:#f7faf9; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --bd:#e5e7eb;
    --brand:#34d399; --brand-2:#a78bfa; --progress-bg:#e8eef1;
    --ok:#22c55e20; --warn:#f59e0b20; --due:#ef444420;
    --danger:#ef4444; --warn-strong:#f59e0b; --ok-strong:#22c55e;
  }
  body{font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:24px auto;max-width:980px;padding:0 12px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  h1{font-size:24px;margin:0}
  .flag{font-size:26px;vertical-align:-3px}
  .muted{color:var(--muted)}
  .hidden{display:none}
  input,button,select{padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  button{cursor:pointer}
  .primary{background:var(--brand);color:#fff;border-color:transparent}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:720px){.grid{grid-template-columns:1fr}}
  .card{
    background: radial-gradient(120% 120% at 100% 0%, rgba(167,139,250,.10), rgba(255,255,255,.90) 60%), var(--panel);
    border:1px solid var(--bd);border-radius:12px;padding:12px;margin:10px 0;
    transition:.18s ease;
  }
  .list-item{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}
  .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-right:6px}

  .progress{height:6px;background:var(--progress-bg);border-radius:999px;overflow:hidden;margin-top:6px}
  .progress i{display:block;height:100%;width:var(--pct,0%);background:linear-gradient(90deg,var(--brand),var(--brand-2));transition:width .35s ease;border-radius:inherit}

  .card.is-ok{box-shadow:0 0 0 6px var(--ok) inset}
  .card.is-warn{box-shadow:0 0 0 6px var(--warn) inset}
  .card.is-due{box-shadow:0 0 0 6px var(--due) inset}

  .pkg-row{display:flex;align-items:center;gap:8px}
  .note{font-size:13px}

  .credits{text-align:center;color:#d4af37;font-size:12px;margin:28px 0 8px;opacity:.9}

  #overlay{position:fixed;inset:0;background:rgba(15,23,42,.5);backdrop-filter:saturate(120%) blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
  #modal{width:min(680px,92vw);background:#fff;border-radius:16px;border:1px solid var(--bd);box-shadow:0 20px 60px rgba(16,24,40,.22);padding:18px}
  #modal header{display:flex;justify-content:space-between;align-items:center;margin:0 0 8px 0}
  #modal h3{margin:0;font-size:14px;color:var(--muted)}
  #frontTerm{font-size:32px;text-align:center;margin:18px 0 6px 0}
  #revHint{font-size:13px;color:var(--muted);text-align:center;margin-bottom:10px}
  #revAnswer{border-top:1px dashed var(--bd);padding-top:8px;margin-top:6px}
  .btn-line{display:flex;gap:8px;justify-content:center;margin-top:12px}
  .btn-bad{background:var(--danger);color:#fff;border-color:transparent}
  .btn-mid{background:var(--warn-strong);color:#fff;border-color:transparent}
  .btn-good{background:var(--ok-strong);color:#fff;border-color:transparent}
  .pill{border-radius:999px;padding:.35rem .8rem}
</style>
</head>
<body>

<header>
  <span class="flag" aria-hidden="true">ðŸ‡µðŸ‡­</span>
  <h1>Tagalog</h1>
  <div class="row" style="margin-left:auto">
    <span class="muted">Racha: ðŸ”¥ <b id="streakVal">0</b></span>
    <button id="resetStreakBtn">Reiniciar</button>
    <button id="themeBtn">Tema</button>
    <span id="userEmail" class="muted"></span>
    <button id="signOutBtn">Salir</button>
  </div>
</header>

<section id="appSection">
  <div class="card">
    <h3>Agregar palabra</h3>
    <div class="grid">
      <input id="term" placeholder="Palabra en Tagalog *">
      <input id="meaning" placeholder="Significado (ES/EN)">
      <input id="example" placeholder="Ejemplo de uso">
      <input id="tags" placeholder="Etiquetas: saludo,verbo (coma separadas)">
    </div>
    <div class="row" style="margin-top:6px">
      <select id="fromLang"><option>Tagalog</option><option>Spanish</option><option>English</option></select>
      <select id="toLang"><option>Spanish</option><option>English</option></select>
      <button id="parseBtn">Parsear</button>
      <button class="primary" id="addBtn">Agregar</button>
      <button id="exportBtn">Exportar CSV</button>
    </div>
    <div class="row" style="margin-top:6px">
      <input id="search" placeholder="Buscar..." style="flex:1">
      <select id="sort">
        <option value="created_at.desc">Recientes primero</option>
        <option value="term.asc">Aâ€“Z</option>
        <option value="term.desc">Zâ€“A</option>
        <option value="updated_at.desc">Editadas reciente</option>
      </select>
      <span class="muted" id="countLabel"></span>
    </div>
  </div>

  <div class="card">
    <h3>Paquetes (CategorÃ­as)</h3>
    <div class="pkg-row">
      <select id="pkgSelect">
        <option value="conversation">ConversaciÃ³n</option>
        <option value="restaurant">Restaurante</option>
        <option value="basics">BÃ¡sicos</option>
      </select>
      <button id="loadPkgBtn">Cargar</button>
      <span class="note muted">Inserta un pequeÃ±o paquete de ejemplo (Tagalog â†’ Spanish).</span>
    </div>
  </div>

  <div id="list" class="card"></div>

  <div class="row" style="align-items:center">
    <button class="primary" id="reviewBtn">Repasar hoy</button>
    <select id="revScope">
      <option value="due">Pendientes</option>
      <option value="hard">DifÃ­ciles</option>
      <option value="all">Todas</option>
    </select>
    <select id="revCount">
      <option>5</option><option>10</option><option>15</option>
    </select>
    <span id="dueInfo" class="muted"></span>
  </div>
</section>

<!-- MODAL prÃ¡ctica -->
<div id="overlay" aria-hidden="true">
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modTitle">
    <header>
      <h3 id="modTitle">Tarjeta <span id="revPos">0</span></h3>
      <button id="closeModalBtn">Cerrar</button>
    </header>
    <div id="frontTerm">â€”</div>
    <div id="revHint" class="muted"></div>
    <div style="text-align:center">
      <button id="showAnsBtn" class="pill">Mostrar significado</button>
    </div>
    <div id="revAnswer" class="hidden">
      <strong id="revMeaning"></strong>
      <div id="revExample" class="muted" style="margin-top:6px"></div>
    </div>
    <div class="btn-line">
      <button class="pill btn-bad"  data-q="0">DifÃ­cil</button>
      <button class="pill btn-mid"  data-q="3">Regular</button>
      <button class="pill btn-good" data-q="5">FÃ¡cil</button>
    </div>
  </div>
</div>

<footer class="credits">Gawa ni Harry</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://wszrttutzsmzayzpbnjq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzenJ0dHV0enNtemF5enBibmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODI4MzAsImV4cCI6MjA3MTE1ODgzMH0.2Xkc4vCPbJ1W9Sbp78Ae_qvKZHC_GP8Dtq4Ub6ZZW1M";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Helpers ===== */
const qs = s => document.querySelector(s);
const listEl = qs('#list'), countEl = qs('#countLabel');
const overlay = qs('#overlay'), modal = qs('#modal');
const streakVal = qs('#streakVal');
function toast(m){ alert(m); }
function esc(s){ return String(s??'').replace(/[&<>"/']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* ===== Tema ===== */
qs('#themeBtn').onclick = () => {
  const dark = document.documentElement.dataset.theme === 'dark';
  document.documentElement.dataset.theme = dark ? 'light' : 'dark';
  document.body.style.background = dark ? 'var(--bg)' : '#111827';
  document.body.style.color = dark ? 'var(--ink)' : '#e5e7eb';
};

/* ===== SesiÃ³n ===== */
client.auth.getSession().then(({data:{session}})=>{ if(session) onAuthed(); });
qs('#signOutBtn').onclick = async ()=>{ await client.auth.signOut(); location.reload(); };

/* ===== Estado ===== */
let reviewQueue=[], current=null, reviewed=0;
let wordsCache=[];  // << cache local para re-pintar instantÃ¡neo

/* ===== Agregar ===== */
qs('#parseBtn').onclick = ()=>{
  const raw = qs('#example').value.trim(); if(!raw) return toast('Nada para parsear');
  const p = raw.split('|').map(s=>s.trim());
  if(p[0]) qs('#term').value=p[0]; if(p[1]) qs('#meaning').value=p[1];
  if(p[2]) qs('#tags').value=p[2]; if(p[3]) qs('#example').value=p[3];
};

qs('#addBtn').onclick = addWord;
async function addWord(){
  const term = qs('#term').value.trim();
  const meaning = qs('#meaning').value.trim();
  const example = qs('#example').value.trim();
  const tagsRaw = qs('#tags').value.trim();
  const tags = tagsRaw ? tagsRaw.split(',').map(s=>s.trim()).filter(Boolean) : null;
  if(!term || !meaning) return toast('Palabra y significado son obligatorios');

  const { data:{session} } = await client.auth.getSession();
  if(!session) return toast('IniciÃ¡ sesiÃ³n');

  const row = {
    user_id: session.user.id, term, meaning,
    example: example || null, notes: null, tags,
    from_lang: qs('#fromLang').value, to_lang: qs('#toLang').value,
    ease: 2.5, repetitions: 0, interval_days: 1,
    last_review_at: null,
    next_review_at: new Date().toISOString()
  };

  // INSERCIÃ“N + DEVOLVER FILA, y actualizar cache para render inmediato
  const { data:newRow, error } = await client.from('words').insert(row).select('*').single();
  if(error){ console.error(error); return toast('No se pudo guardar: '+error.message); }

  // limpiar inputs
  ['#term','#meaning','#example','#tags'].forEach(id=>qs(id).value='');

  // actualizar cache y re-render sin refrescar
  wordsCache = [newRow, ...wordsCache];
  renderList(wordsCache);
}

/* ===== Listar ===== */
qs('#search').oninput = ()=>loadWords();
qs('#sort').onchange = ()=>loadWords();

async function onAuthed(){
  const { data:{ user } } = await client.auth.getUser();
  qs('#userEmail').textContent = user?.email || '';
  await loadWords();
  updateStreakBadge();
}

async function loadWords(){
  const { data:{session} } = await client.auth.getSession(); if(!session) return;
  const q = qs('#search').value.trim();
  const [col, dir] = (qs('#sort').value||'created_at.desc').split('.');
  let query = client.from('words').select('*').eq('user_id', session.user.id)
    .order(col, { ascending: dir !== 'desc' }).limit(500);
  if(q) query = query.or(`term.ilike.%${q}%,meaning.ilike.%${q}%`);
  const { data, error } = await query;
  if(error){ console.error(error); return toast(error.message); }
  wordsCache = data||[];
  renderList(wordsCache);
}

/* ===== Progreso visual ===== */
function masteryPct(row){
  if(!row || (row.repetitions||0) === 0) return 0;
  const reps = row.repetitions || 0;
  const ease = row.ease || 2.5;
  let base = Math.min(100, reps * 20);
  let bonus = Math.max(0, ease - 2.3) * 10;
  const last = new Date(row.last_review_at || row.created_at);
  const now = new Date();
  const days = (now - last)/86400000;
  const interval = Math.max(1, row.interval_days || 1);
  const freshness = Math.max(0, 1 - (days/interval)*0.35);
  let pct = (base + bonus) * freshness;
  return Math.max(0, Math.min(100, Math.round(pct)));
}

function renderList(rows){
  countEl.textContent = `${rows.length} palabra(s)`;
  listEl.innerHTML = '';
  if(!rows.length){ listEl.innerHTML = `<div class="muted">No hay resultados. AgregÃ¡ tu primera palabra ðŸ«°</div>`; return; }
  rows.forEach(r=>{
    const pct = masteryPct(r);
    const halo = pct > 60 ? 'is-ok' : pct > 25 ? 'is-warn' : 'is-due';
    const div = document.createElement('div');
    div.className = `list-item card ${halo}`;
    div.innerHTML = `
      <div>
        <strong>${esc(r.term)}</strong>
        <div class="muted">${esc(r.example||'')}</div>
        <div class="progress"><i style="--pct:${pct}%"></i></div>
      </div>
      <div>
        ${esc(r.meaning||'')}
        <div>${(r.tags||[]).map(t=>`<span class="chip">${esc(t)}</span>`).join('')}</div>
      </div>
      <div class="right">
        <button onclick="delWord('${r.id}')">Eliminar</button>
      </div>`;
    listEl.appendChild(div);
  });
}
window.delWord = async id=>{
  const { error } = await client.from('words').delete().eq('id', id);
  if(error){ console.error(error); return toast(error.message); }
  await loadWords();
};

/* ===== Exportar ===== */
qs('#exportBtn').onclick = async ()=>{
  const { data:{session} } = await client.auth.getSession(); if(!session) return;
  const { data, error } = await client.from('words').select('*').eq('user_id', session.user.id);
  if(error) return toast(error.message);
  const rows = data||[];
  const csv = ['term,meaning,example,notes,tags,from_lang,to_lang,created_at']
    .concat(rows.map(r=>[
      r.term, r.meaning, r.example||'', r.notes||'', (r.tags||[]).join('|'),
      r.from_lang||'', r.to_lang||'', r.created_at
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='talalog.csv'; a.click(); URL.revokeObjectURL(url);
};

/* ===== Paquetes demo ===== */
qs('#loadPkgBtn').onclick = async ()=>{
  const opt = qs('#pkgSelect').value;
  const sample = {
    conversation: [
      {term:'kamusta', meaning:'Â¿cÃ³mo estÃ¡s?', example:'Kamusta ka?', tags:['conversation']},
      {term:'salamat', meaning:'gracias', example:'Salamat po.', tags:['basics','conversation']},
      {term:'oo', meaning:'sÃ­', example:'Oo, sige.', tags:['basics']},
      {term:'hindi', meaning:'no', example:'Hindi po.', tags:['basics']},
      {term:'pakiusap', meaning:'por favor', example:'Pakiusap, tulungan mo ako.', tags:['conversation']},
      {term:'magkano', meaning:'Â¿cuÃ¡nto cuesta?', example:'Magkano ito?', tags:['shopping']},
      {term:'gusto', meaning:'gustar / querer', example:'Gusto ko ng kape.', tags:['basics']},
      {term:'pahingi', meaning:'Â¿me das...?', example:'Pahingi ng tubig.', tags:['conversation']},
      {term:'opo', meaning:'sÃ­ (formal)', example:'Opo.', tags:['basics']},
      {term:'pasensya', meaning:'perdÃ³n', example:'Pasensya na.', tags:['conversation']},
      {term:'tulong', meaning:'ayuda', example:'Tulong!', tags:['emergency']},
      {term:'paalam', meaning:'adiÃ³s', example:'Paalam!', tags:['basics']}
    ],
    restaurant: [
      {term:'kafe', meaning:'cafÃ©', example:'Gusto ko ng kape.', tags:['restaurant']},
      {term:'kanin', meaning:'arroz', example:'May kanin ba?', tags:['restaurant']},
      {term:'tubig', meaning:'agua', example:'Tubig, please.', tags:['restaurant']},
    ],
    basics: [
      {term:'bahay', meaning:'casa', example:'Nasa bahay ako.', tags:['basics']},
      {term:'trabaho', meaning:'trabajo', example:'May trabaho ako.', tags:['basics']},
    ]
  }[opt];

  const { data:{session} } = await client.auth.getSession();
  if(!session) return toast('IniciÃ¡ sesiÃ³n');
  const rows = (sample||[]).map(x=>({
    user_id: session.user.id, from_lang:'Tagalog', to_lang:'Spanish',
    ease:2.5, repetitions:0, interval_days:1,
    next_review_at: new Date().toISOString(),
    ...x
  }));
  if(!rows.length) return;
  const { error } = await client.from('words').insert(rows);
  if(error){ console.error(error); return toast(error.message); }
  await loadWords();
};

/* ===== PrÃ¡ctica ===== */
const showAnsBtn = qs('#showAnsBtn');
qs('#reviewBtn').onclick = startReview;
showAnsBtn.onclick = ()=>qs('#revAnswer').classList.toggle('hidden');
qs('#closeModalBtn').onclick = closeModal;
overlay.addEventListener('click', e=>{ if(e.target===overlay) closeModal(); });

function openModal(){ overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); }
function closeModal(){ overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); current=null; }

async function startReview(){
  const scope = qs('#revScope').value;   // due | hard | all
  const count = Number(qs('#revCount').value)||5;

  const { data:{session} } = await client.auth.getSession(); if(!session) return;
  let query = client.from('words').select('*').eq('user_id', session.user.id);

  if(scope==='due'){
    const now = new Date().toISOString();
    query = query.lte('next_review_at', now).order('next_review_at',{ascending:true});
  }else if(scope==='hard'){
    query = query.order('ease',{ascending:true}).order('repetitions',{ascending:true});
  }else{
    query = query.order('updated_at',{ascending:false}).order('created_at',{ascending:false});
  }
  let { data, error } = await query.limit(200);
  if(error){ console.error(error); return toast(error.message); }

  // === MODO LIBRE automÃ¡tico: si no hay tarjetas segÃºn el filtro, practicamos "Todas" mezcladas ===
  if(!data || !data.length){
    const alt = await client.from('words').select('*').eq('user_id', session.user.id)
      .order('updated_at',{ascending:false}).order('created_at',{ascending:false}).limit(200);
    data = alt.data || [];
  }

  reviewQueue = shuffle((data||[]).slice(0, count));
  reviewed = 0;
  qs('#dueInfo').textContent = `${reviewQueue.length} para repasar`;

  if(!reviewQueue.length){ toast('No hay tarjetas para practicar aÃºn.'); return; }
  nextCard();
  openModal();
}

function nextCard(){
  current = reviewQueue.shift();
  if(!current){
    closeModal();
    toast('Â¡Repaso listo!');
    loadWords();
    bumpStreak();
    return;
  }
  reviewed++;
  qs('#revPos').textContent = `${reviewed}`;
  qs('#frontTerm').textContent = current.term;
  qs('#revHint').textContent = (current.from_lang||'Tagalog')+' â†’ '+(current.to_lang||'Spanish');
  qs('#revMeaning').textContent = current.meaning||'';
  qs('#revExample').textContent = current.example||'';
  qs('#revAnswer').classList.add('hidden');
}

modal.querySelectorAll('[data-q]').forEach(btn=>{
  btn.addEventListener('click', ()=>gradeCard(+btn.dataset.q));
});

function sm2(prevEase=2.5, prevInterval=0, prevReps=0, q=3){
  let EF = prevEase, reps = prevReps, I = prevInterval;
  if (q < 3) { reps = 0; I = 1; }
  else {
    if (reps === 0) I = 1;
    else if (reps === 1) I = 6;
    else I = Math.round(I * EF);
    reps += 1;
    EF = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
    if (EF < 1.3) EF = 1.3;
  }
  return { EF, I, reps };
}

async function gradeCard(q){
  if(!current) return;
  const { EF, I, reps } = sm2(current.ease||2.5, current.interval_days||1, current.repetitions||0, q);
  const next = new Date(); next.setDate(next.getDate() + (I||1));
  const updates = {
    ease: EF, interval_days: I, repetitions: reps,
    last_review_at: new Date().toISOString(),
    next_review_at: next.toISOString()
  };
  const { error } = await client.from('words').update(updates).eq('id', current.id);
  if(error){ console.error(error); return toast('No pude actualizar: '+error.message); }
  nextCard();
}

/* ===== Racha ===== */
function readStreak(){ return Number(localStorage.getItem('streak')||0); }
function writeStreak(n){ localStorage.setItem('streak', String(n)); updateStreakBadge(); }
function updateStreakBadge(){ streakVal.textContent = readStreak(); }
function bumpStreak(){ writeStreak(readStreak()+1); }
qs('#resetStreakBtn').onclick = ()=>{ if(confirm('Reiniciar racha?')) writeStreak(0); };
</script>
</body>
</html>
